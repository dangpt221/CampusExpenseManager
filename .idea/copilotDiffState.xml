<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/campusexpensesmanagermer/Activities/Budgets/AddBudgetActivity.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/campusexpensesmanagermer/Activities/Budgets/AddBudgetActivity.java" />
              <option name="originalContent" value="package com.example.campusexpensesmanagermer.Activities.Budgets;&#10;&#10;import android.content.Intent;&#10;import android.content.SharedPreferences;&#10;import android.os.Bundle;&#10;import android.text.TextUtils;&#10;import android.util.Log;&#10;import android.widget.ArrayAdapter;&#10;import android.widget.Button;&#10;import android.widget.EditText;&#10;import android.widget.Spinner;&#10;import android.widget.Toast;&#10;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;&#10;import com.example.campusexpensesmanagermer.Models.Budget;&#10;import com.example.campusexpensesmanagermer.Models.BudgetItem;&#10;import com.example.campusexpensesmanagermer.R;&#10;import com.example.campusexpensesmanagermer.Repositories.BudgetRepository;&#10;import com.example.campusexpensesmanagermer.Repositories.BudgetItemRepository;&#10;&#10;import java.util.Calendar;&#10;&#10;public class AddBudgetActivity extends AppCompatActivity {&#10;&#10;    public static final String EXTRA_MONTH = &quot;EXTRA_MONTH&quot;;&#10;    public static final String EXTRA_YEAR = &quot;EXTRA_YEAR&quot;;&#10;    public static final String EXTRA_BUDGET_ID = &quot;EXTRA_BUDGET_ID&quot;;&#10;&#10;    private EditText edtTargetAmount, edtNote;&#10;    private Spinner spinnerMonth, spinnerYear;&#10;    private Button btnAddBudget, btnCancel;&#10;    private BudgetRepository budgetRepository;&#10;    private BudgetItemRepository budgetItemRepository;&#10;    private SharedPreferences prefs;&#10;    private int userId;&#10;&#10;    private static final String PREFS_NAME = &quot;CampusExpensesPrefs&quot;;&#10;    private static final String TAG = &quot;AddBudgetActivity&quot;;&#10;&#10;    private String[] categories = {&#10;            &quot;Food&quot;, &quot;Transport&quot;, &quot;Shopping&quot;, &quot;Entertainment&quot;,&#10;            &quot;Health&quot;, &quot;Education&quot;, &quot;Housing&quot;, &quot;Utilities&quot;, &quot;Other&quot;&#10;    };&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.activity_add_budget);&#10;&#10;        try {&#10;            initViews();&#10;&#10;            budgetRepository = new BudgetRepository(this);&#10;            budgetItemRepository = new BudgetItemRepository(this);&#10;            prefs = getSharedPreferences(PREFS_NAME, MODE_PRIVATE);&#10;            userId = prefs.getInt(&quot;ID_USER&quot;, 0);&#10;&#10;            Log.d(TAG, &quot;onCreate - userId: &quot; + userId);&#10;&#10;            setupSpinners();&#10;&#10;            if (getSupportActionBar() != null) {&#10;                getSupportActionBar().setTitle(&quot;Add new budget&quot;);&#10;                getSupportActionBar().setDisplayHomeAsUpEnabled(true);&#10;            }&#10;&#10;            btnAddBudget.setOnClickListener(v -&gt; addBudget());&#10;            btnCancel.setOnClickListener(v -&gt; finish());&#10;&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;Error in onCreate: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    private void initViews(){&#10;        edtTargetAmount = findViewById(R.id.edtTargetAmount);&#10;        edtNote = findViewById(R.id.edtNote);&#10;        spinnerMonth = findViewById(R.id.spinnerMonth);&#10;        spinnerYear = findViewById(R.id.spinnerYear);&#10;        btnAddBudget = findViewById(R.id.btnAddBudget);&#10;        btnCancel = findViewById(R.id.btnCancel);&#10;    }&#10;&#10;    private void setupSpinners() {&#10;        String[] months = {&quot;Month 1&quot;, &quot;Month 2&quot;, &quot;Month 3&quot;, &quot;Month 4&quot;, &quot;Month 5&quot;, &quot;Month 6&quot;,&#10;                &quot;Month 7&quot;, &quot;Month 8&quot;, &quot;Month 9&quot;, &quot;Month 10&quot;, &quot;Month 11&quot;, &quot;Month 12&quot;};&#10;        ArrayAdapter&lt;String&gt; monthAdapter = new ArrayAdapter&lt;&gt;(this, android.R.layout.simple_spinner_item, months);&#10;        monthAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);&#10;        spinnerMonth.setAdapter(monthAdapter);&#10;        spinnerMonth.setSelection(Calendar.getInstance().get(Calendar.MONTH));&#10;&#10;        int currentYear = Calendar.getInstance().get(Calendar.YEAR);&#10;        String[] years = new String[5];&#10;        for (int i = 0; i &lt; 5; i++) {&#10;            years[i] = String.valueOf(currentYear - 2 + i);&#10;        }&#10;        ArrayAdapter&lt;String&gt; yearAdapter = new ArrayAdapter&lt;&gt;(this, android.R.layout.simple_spinner_item, years);&#10;        yearAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);&#10;        spinnerYear.setAdapter(yearAdapter);&#10;        spinnerYear.setSelection(2); // Select current year&#10;    }&#10;&#10;    private void addBudget() {&#10;        String amountStr = edtTargetAmount.getText().toString().trim();&#10;        String note = edtNote.getText().toString().trim();&#10;&#10;        if (TextUtils.isEmpty(amountStr) || userId == 0) {&#10;            if (TextUtils.isEmpty(amountStr)) edtTargetAmount.setError(&quot;Please enter amount&quot;);&#10;            if (userId == 0) Toast.makeText(this, &quot;❌ Error: User not found.&quot;, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;&#10;        try {&#10;            double amount = Double.parseDouble(amountStr);&#10;            if (amount &lt;= 0) {&#10;                edtTargetAmount.setError(&quot;Amount must be greater than 0&quot;);&#10;                return;&#10;            }&#10;&#10;            int month = spinnerMonth.getSelectedItemPosition() + 1;&#10;            int year = Integer.parseInt((String) spinnerYear.getSelectedItem());&#10;&#10;            Budget budget = new Budget();&#10;            budget.setUserId(userId);&#10;            budget.setMonth(month);&#10;            budget.setYear(year);&#10;            budget.setMoney(amount);&#10;            budget.setDescription(note);&#10;&#10;            long budgetId = budgetRepository.addBudget(budget);&#10;&#10;            if (budgetId &gt; 0) {&#10;                // --- NEW: compute allocations using integer minor units (cents) to avoid rounding issues ---&#10;                // Use 100 as scale to support two decimal places for currencies with cents. For VND (no cents)&#10;                // this will still work as amounts will be whole numbers.&#10;                long totalCents = Math.round(amount * 100.0);&#10;                int n = categories.length;&#10;&#10;                if (n &gt; 0) {&#10;                    long base = totalCents / n;&#10;                    int rem = (int) (totalCents % n); // remainder to distribute&#10;&#10;                    for (int i = 0; i &lt; n; i++) {&#10;                        long amountCents = base + (i &lt; rem ? 1 : 0);&#10;                        double amountPerCategory = amountCents / 100.0;&#10;                        BudgetItem item = new BudgetItem((int) budgetId, categories[i], amountPerCategory);&#10;                        budgetItemRepository.addBudgetItem(item);&#10;                    }&#10;                }&#10;&#10;                // --- END new allocation logic ---&#10;&#10;                Toast.makeText(this, &quot;✅ Budget added successfully!&quot;, Toast.LENGTH_SHORT).show();&#10;&#10;                Intent resultIntent = new Intent();&#10;                resultIntent.putExtra(EXTRA_MONTH, month);&#10;                resultIntent.putExtra(EXTRA_YEAR, year);&#10;                resultIntent.putExtra(EXTRA_BUDGET_ID, (int) budgetId);&#10;                setResult(RESULT_OK, resultIntent);&#10;                finish();&#10;&#10;            } else {&#10;                Toast.makeText(this, &quot;❌ Error: Failed to add budget&quot;, Toast.LENGTH_SHORT).show();&#10;            }&#10;        } catch (Exception e) {&#10;            Toast.makeText(this, &quot;❌ Error: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;            Log.e(TAG, &quot;Exception: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public boolean onSupportNavigateUp() {&#10;        finish();&#10;        return true;&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.campusexpensesmanagermer.Activities.Budgets;&#13;&#10;&#13;&#10;import android.content.Intent;&#13;&#10;import android.content.SharedPreferences;&#13;&#10;import android.os.Bundle;&#13;&#10;import android.text.TextUtils;&#13;&#10;import android.util.Log;&#13;&#10;import android.widget.ArrayAdapter;&#13;&#10;import android.widget.Button;&#13;&#10;import android.widget.EditText;&#13;&#10;import android.widget.Spinner;&#13;&#10;import android.widget.Toast;&#13;&#10;&#13;&#10;import androidx.appcompat.app.AppCompatActivity;&#13;&#10;&#13;&#10;import com.example.campusexpensesmanagermer.Models.Budget;&#13;&#10;import com.example.campusexpensesmanagermer.Models.BudgetItem;&#13;&#10;import com.example.campusexpensesmanagermer.R;&#13;&#10;import com.example.campusexpensesmanagermer.Repositories.BudgetRepository;&#13;&#10;import com.example.campusexpensesmanagermer.Repositories.BudgetItemRepository;&#13;&#10;&#13;&#10;import java.util.Calendar;&#13;&#10;&#13;&#10;public class AddBudgetActivity extends AppCompatActivity {&#13;&#10;&#13;&#10;    public static final String EXTRA_MONTH = &quot;EXTRA_MONTH&quot;;&#13;&#10;    public static final String EXTRA_YEAR = &quot;EXTRA_YEAR&quot;;&#13;&#10;    public static final String EXTRA_BUDGET_ID = &quot;EXTRA_BUDGET_ID&quot;;&#13;&#10;&#13;&#10;    private EditText edtTargetAmount, edtNote;&#13;&#10;    private Spinner spinnerMonth, spinnerYear;&#13;&#10;    private Button btnAddBudget, btnCancel;&#13;&#10;    private BudgetRepository budgetRepository;&#13;&#10;    private BudgetItemRepository budgetItemRepository;&#13;&#10;    private SharedPreferences prefs;&#13;&#10;    private int userId;&#13;&#10;&#13;&#10;    private static final String PREFS_NAME = &quot;CampusExpensesPrefs&quot;;&#13;&#10;    private static final String TAG = &quot;AddBudgetActivity&quot;;&#13;&#10;&#13;&#10;    private String[] categories = {&#13;&#10;            &quot;Food&quot;, &quot;Transport&quot;, &quot;Shopping&quot;, &quot;Entertainment&quot;,&#13;&#10;            &quot;Health&quot;, &quot;Education&quot;, &quot;Housing&quot;, &quot;Utilities&quot;, &quot;Other&quot;&#13;&#10;    };&#13;&#10;&#13;&#10;    @Override&#13;&#10;    protected void onCreate(Bundle savedInstanceState) {&#13;&#10;        super.onCreate(savedInstanceState);&#13;&#10;        setContentView(R.layout.activity_add_budget);&#13;&#10;&#13;&#10;        try {&#13;&#10;            initViews();&#13;&#10;&#13;&#10;            budgetRepository = new BudgetRepository(this);&#13;&#10;            budgetItemRepository = new BudgetItemRepository(this);&#13;&#10;            prefs = getSharedPreferences(PREFS_NAME, MODE_PRIVATE);&#13;&#10;            userId = prefs.getInt(&quot;ID_USER&quot;, 0);&#13;&#10;&#13;&#10;            Log.d(TAG, &quot;onCreate - userId: &quot; + userId);&#13;&#10;&#13;&#10;            setupSpinners();&#13;&#10;&#13;&#10;            if (getSupportActionBar() != null) {&#13;&#10;                getSupportActionBar().setTitle(&quot;Add new budget&quot;);&#13;&#10;                getSupportActionBar().setDisplayHomeAsUpEnabled(true);&#13;&#10;            }&#13;&#10;&#13;&#10;            btnAddBudget.setOnClickListener(v -&gt; addBudget());&#13;&#10;            btnCancel.setOnClickListener(v -&gt; finish());&#13;&#10;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;Error in onCreate: &quot; + e.getMessage(), e);&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    private void initViews(){&#13;&#10;        edtTargetAmount = findViewById(R.id.edtTargetAmount);&#13;&#10;        edtNote = findViewById(R.id.edtNote);&#13;&#10;        spinnerMonth = findViewById(R.id.spinnerMonth);&#13;&#10;        spinnerYear = findViewById(R.id.spinnerYear);&#13;&#10;        btnAddBudget = findViewById(R.id.btnAddBudget);&#13;&#10;        btnCancel = findViewById(R.id.btnCancel);&#13;&#10;    }&#13;&#10;&#13;&#10;    private void setupSpinners() {&#13;&#10;        String[] months = {&quot;Month 1&quot;, &quot;Month 2&quot;, &quot;Month 3&quot;, &quot;Month 4&quot;, &quot;Month 5&quot;, &quot;Month 6&quot;,&#13;&#10;                &quot;Month 7&quot;, &quot;Month 8&quot;, &quot;Month 9&quot;, &quot;Month 10&quot;, &quot;Month 11&quot;, &quot;Month 12&quot;};&#13;&#10;        ArrayAdapter&lt;String&gt; monthAdapter = new ArrayAdapter&lt;&gt;(this, android.R.layout.simple_spinner_item, months);&#13;&#10;        monthAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);&#13;&#10;        spinnerMonth.setAdapter(monthAdapter);&#13;&#10;        spinnerMonth.setSelection(Calendar.getInstance().get(Calendar.MONTH));&#13;&#10;&#13;&#10;        int currentYear = Calendar.getInstance().get(Calendar.YEAR);&#13;&#10;        String[] years = new String[5];&#13;&#10;        for (int i = 0; i &lt; 5; i++) {&#13;&#10;            years[i] = String.valueOf(currentYear - 2 + i);&#13;&#10;        }&#13;&#10;        ArrayAdapter&lt;String&gt; yearAdapter = new ArrayAdapter&lt;&gt;(this, android.R.layout.simple_spinner_item, years);&#13;&#10;        yearAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);&#13;&#10;        spinnerYear.setAdapter(yearAdapter);&#13;&#10;        spinnerYear.setSelection(2); // Select current year&#13;&#10;    }&#13;&#10;&#13;&#10;    private void addBudget() {&#13;&#10;        String amountStr = edtTargetAmount.getText().toString().trim();&#13;&#10;        String note = edtNote.getText().toString().trim();&#13;&#10;&#13;&#10;        if (TextUtils.isEmpty(amountStr) || userId == 0) {&#13;&#10;            if (TextUtils.isEmpty(amountStr)) edtTargetAmount.setError(&quot;Please enter amount&quot;);&#13;&#10;            if (userId == 0) Toast.makeText(this, &quot;❌ Error: User not found.&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;            return;&#13;&#10;        }&#13;&#10;&#13;&#10;        try {&#13;&#10;            double amount = Double.parseDouble(amountStr);&#13;&#10;            if (amount &lt;= 0) {&#13;&#10;                edtTargetAmount.setError(&quot;Amount must be greater than 0&quot;);&#13;&#10;                return;&#13;&#10;            }&#13;&#10;&#13;&#10;            int month = spinnerMonth.getSelectedItemPosition() + 1;&#13;&#10;            int year = Integer.parseInt((String) spinnerYear.getSelectedItem());&#13;&#10;&#13;&#10;            Budget budget = new Budget();&#13;&#10;            budget.setUserId(userId);&#13;&#10;            budget.setMonth(month);&#13;&#10;            budget.setYear(year);&#13;&#10;            budget.setMoney(amount);&#13;&#10;            budget.setDescription(note);&#13;&#10;&#13;&#10;            long budgetId = budgetRepository.addBudget(budget);&#13;&#10;&#13;&#10;            if (budgetId &gt; 0) {&#13;&#10;                // --- NEW: compute allocations using integer minor units (cents) to avoid rounding issues ---&#13;&#10;                long totalCents = Math.round(amount * 100.0);&#13;&#10;                int n = categories.length;&#13;&#10;&#13;&#10;                if (n &gt; 0) {&#13;&#10;                    long base = totalCents / n;&#13;&#10;                    int rem = (int) (totalCents % n); // remainder to distribute&#13;&#10;&#13;&#10;                    java.util.List&lt;BudgetItem&gt; itemsToInsert = new java.util.ArrayList&lt;&gt;();&#13;&#10;&#13;&#10;                    for (int i = 0; i &lt; n; i++) {&#13;&#10;                        long amountCents = base + (i &lt; rem ? 1 : 0);&#13;&#10;                        double amountPerCategory = amountCents / 100.0;&#13;&#10;                        BudgetItem item = new BudgetItem((int) budgetId, categories[i], amountPerCategory);&#13;&#10;                        itemsToInsert.add(item);&#13;&#10;                    }&#13;&#10;&#13;&#10;                    boolean inserted = budgetItemRepository.addBudgetItemsInTransaction(itemsToInsert);&#13;&#10;                    if (!inserted) {&#13;&#10;                        Log.e(TAG, &quot;✗ Some budget items may have failed to insert in transaction&quot;);&#13;&#10;                    }&#13;&#10;                } else {&#13;&#10;                    Log.w(TAG, &quot;No categories available to allocate budget&quot;);&#13;&#10;                }&#13;&#10;&#13;&#10;                // --- END new allocation logic ---&#13;&#10;&#13;&#10;                Toast.makeText(this, &quot;✅ Budget added successfully!&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;&#13;&#10;                Intent resultIntent = new Intent();&#13;&#10;                resultIntent.putExtra(EXTRA_MONTH, month);&#13;&#10;                resultIntent.putExtra(EXTRA_YEAR, year);&#13;&#10;                resultIntent.putExtra(EXTRA_BUDGET_ID, (int) budgetId);&#13;&#10;                setResult(RESULT_OK, resultIntent);&#13;&#10;                finish();&#13;&#10;&#13;&#10;            } else {&#13;&#10;                Toast.makeText(this, &quot;❌ Error: Failed to add budget&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Toast.makeText(this, &quot;❌ Error: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#13;&#10;            Log.e(TAG, &quot;Exception: &quot; + e.getMessage(), e);&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public boolean onSupportNavigateUp() {&#13;&#10;        finish();&#13;&#10;        return true;&#13;&#10;    }&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/campusexpensesmanagermer/Fragments/BudgetFragment.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/campusexpensesmanagermer/Fragments/BudgetFragment.java" />
              <option name="originalContent" value="package com.example.campusexpensesmanagermer.Fragments;&#10;&#10;import android.app.Activity;&#10;import android.content.Intent;&#10;import android.content.SharedPreferences;&#10;import android.os.Bundle;&#10;import android.util.Log;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.Button;&#10;import android.widget.EditText;&#10;import android.widget.ProgressBar;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.annotation.Nullable;&#10;import androidx.appcompat.app.AlertDialog;&#10;import androidx.core.content.ContextCompat;&#10;import androidx.fragment.app.Fragment;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.example.campusexpensesmanagermer.Activities.Budgets.AddBudgetActivity;&#10;import com.example.campusexpensesmanagermer.Adapters.BudgetAdapter;&#10;import com.example.campusexpensesmanagermer.Models.Budget;&#10;import com.example.campusexpensesmanagermer.Models.BudgetItem;&#10;import com.example.campusexpensesmanagermer.R;&#10;import com.example.campusexpensesmanagermer.Utils.CurrencyUtils;&#10;import com.example.campusexpensesmanagermer.Repositories.BudgetRepository;&#10;import com.example.campusexpensesmanagermer.Repositories.BudgetItemRepository;&#10;import com.google.android.material.floatingactionbutton.FloatingActionButton;&#10;&#10;import java.util.ArrayList;&#10;import java.util.Calendar;&#10;import java.util.List;&#10;import java.util.Locale;&#10;&#10;public class BudgetFragment extends Fragment implements BudgetAdapter.OnBudgetItemClickListener {&#10;&#10;    private BudgetRepository budgetRepository;&#10;    private BudgetItemRepository budgetItemRepository;&#10;    private SharedPreferences prefs;&#10;    private int userId;&#10;&#10;    private TextView tvTotalBudget, tvTotalSpent, tvRemaining, tvEmptyState;&#10;    private ProgressBar budgetProgressBar;&#10;    private RecyclerView rvBudgetItems;&#10;    private BudgetAdapter budgetAdapter;&#10;    private List&lt;BudgetItem&gt; budgetItems;&#10;&#10;    private FloatingActionButton fabAddBudget;&#10;    private Button btnPrevMonth, btnNextMonth;&#10;    private TextView tvCurrentMonth;&#10;&#10;    private int currentMonth;&#10;    private int currentYear;&#10;    private Budget currentBudget;&#10;&#10;    private static final String PREFS_NAME = &quot;CampusExpensesPrefs&quot;;&#10;    private static final String TAG = &quot;BudgetFragment&quot;;&#10;    private static final int ADD_BUDGET_REQUEST_CODE = 1;&#10;&#10;    @Override&#10;    public void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        try {&#10;            budgetRepository = new BudgetRepository(getContext());&#10;            budgetItemRepository = new BudgetItemRepository(getContext());&#10;            prefs = requireActivity().getSharedPreferences(PREFS_NAME, 0);&#10;            userId = prefs.getInt(&quot;ID_USER&quot;, 0);&#10;&#10;            currentMonth = Calendar.getInstance().get(Calendar.MONTH) + 1;&#10;            currentYear = Calendar.getInstance().get(Calendar.YEAR);&#10;&#10;            Log.d(TAG, &quot;✓ onCreate - userId: &quot; + userId + &quot;, Current Month: &quot; + currentMonth + &quot;/&quot; + currentYear);&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error in onCreate: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public View onCreateView(LayoutInflater inflater, ViewGroup container,&#10;                             Bundle savedInstanceState) {&#10;        View view = inflater.inflate(R.layout.fragment_budget, container, false);&#10;&#10;        try {&#10;            initViews(view);&#10;            setupRecyclerView();&#10;            setupListeners();&#10;            loadBudgetData();&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error in onCreateView: &quot; + e.getMessage(), e);&#10;        }&#10;&#10;        return view;&#10;    }&#10;&#10;    private void initViews(View view) {&#10;        tvTotalBudget = view.findViewById(R.id.tv_total_budget);&#10;        tvTotalSpent = view.findViewById(R.id.tv_total_spent);&#10;        tvRemaining = view.findViewById(R.id.tv_remaining);&#10;        tvEmptyState = view.findViewById(R.id.tvEmptyState);&#10;        budgetProgressBar = view.findViewById(R.id.budget_progress_bar);&#10;        rvBudgetItems = view.findViewById(R.id.rv_budget_items);&#10;        fabAddBudget = view.findViewById(R.id.fab_add_budget);&#10;        btnPrevMonth = view.findViewById(R.id.btn_prev_month);&#10;        btnNextMonth = view.findViewById(R.id.btn_next_month);&#10;        tvCurrentMonth = view.findViewById(R.id.tv_current_month);&#10;    }&#10;&#10;    private void setupRecyclerView() {&#10;        budgetItems = new ArrayList&lt;&gt;();&#10;        budgetAdapter = new BudgetAdapter(getContext(), budgetItems);&#10;        budgetAdapter.setListener(this);&#10;&#10;        rvBudgetItems.setLayoutManager(new LinearLayoutManager(getContext()));&#10;        rvBudgetItems.setAdapter(budgetAdapter);&#10;    }&#10;&#10;    private void setupListeners() {&#10;        fabAddBudget.setOnClickListener(v -&gt; openAddBudgetActivity());&#10;        btnPrevMonth.setOnClickListener(v -&gt; changeMonth(-1));&#10;        btnNextMonth.setOnClickListener(v -&gt; changeMonth(1));&#10;    }&#10;&#10;    /**&#10;     * ✅ FIX: Load budget data với logic chính xác&#10;     */&#10;    private void loadBudgetData() {&#10;        if (userId == 0) {&#10;            Log.e(TAG, &quot;userId is 0, cannot load budget&quot;);&#10;            showEmptyState(true);&#10;            return;&#10;        }&#10;&#10;        try {&#10;            updateMonthDisplay();&#10;&#10;            // ✅ Lấy budget từ database&#10;            currentBudget = budgetRepository.getBudgetByUserAndMonth(userId, currentMonth, currentYear);&#10;&#10;            if (currentBudget == null) {&#10;                Log.d(TAG, &quot;No budget found for &quot; + currentMonth + &quot;/&quot; + currentYear);&#10;                showEmptyState(true);&#10;                return;&#10;            }&#10;&#10;            Log.d(TAG, &quot;✓ Budget loaded: Total=&quot; + currentBudget.getMoney() + &quot;, Spent=&quot; + currentBudget.getSpent());&#10;&#10;            // Load budget items&#10;            List&lt;BudgetItem&gt; items = budgetItemRepository.getBudgetItemsByBudget(currentBudget.getId());&#10;            budgetItems.clear();&#10;            budgetItems.addAll(items);&#10;            budgetAdapter.notifyDataSetChanged();&#10;&#10;            Log.d(TAG, &quot;✓ Loaded &quot; + items.size() + &quot; budget items&quot;);&#10;&#10;            // ✅ Tính tổng đã chi từ các mục (đảm bảo đồng bộ giữa tổng và danh mục)&#10;            double totalSpentFromItems = 0;&#10;            for (BudgetItem bi : items) {&#10;                totalSpentFromItems += bi.getSpentAmount();&#10;            }&#10;&#10;            // Nếu repository trả về giá trị khác (ví dụ tính từ express), ưu tiên giá trị từ DB (tổng các mục)&#10;            if (totalSpentFromItems &gt; 0) {&#10;                currentBudget.setSpent(totalSpentFromItems);&#10;            } else {&#10;                // Fallback: nếu không có mục hoặc tổng bằng 0 thì dùng giá trị tính sẵn&#10;                currentBudget.setSpent(budgetRepository.getTotalSpentByBudget(currentBudget.getId()));&#10;            }&#10;&#10;            // Hiển thị tổng ngân sách và đã chi sau khi đồng bộ&#10;            tvTotalBudget.setText(CurrencyUtils.formatCurrency(requireContext(), currentBudget.getMoney()));&#10;            tvTotalSpent.setText(CurrencyUtils.formatCurrency(requireContext(), currentBudget.getSpent()));&#10;            tvRemaining.setText(CurrencyUtils.formatCurrency(requireContext(), currentBudget.getRemaining()));&#10;&#10;            // ✅ Thay đổi màu nếu vượt quá&#10;            if (currentBudget.isExceeded()) {&#10;                tvRemaining.setTextColor(ContextCompat.getColor(requireContext(), android.R.color.holo_red_dark));&#10;                tvTotalSpent.setTextColor(ContextCompat.getColor(requireContext(), android.R.color.holo_red_dark));&#10;            } else {&#10;                tvRemaining.setTextColor(ContextCompat.getColor(requireContext(), android.R.color.holo_green_dark));&#10;                tvTotalSpent.setTextColor(ContextCompat.getColor(requireContext(), android.R.color.holo_orange_dark));&#10;            }&#10;&#10;            // ✅ Progress bar cập nhật theo tổng mới&#10;            budgetProgressBar.setProgress(currentBudget.getProgressPercentage());&#10;&#10;&#10;            if (items.isEmpty()) {&#10;                rvBudgetItems.setVisibility(View.GONE);&#10;                tvEmptyState.setVisibility(View.VISIBLE);&#10;            } else {&#10;                rvBudgetItems.setVisibility(View.VISIBLE);&#10;                tvEmptyState.setVisibility(View.GONE);&#10;            }&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error loading budget: &quot; + e.getMessage(), e);&#10;            showEmptyState(true);&#10;        }&#10;    }&#10;&#10;    private void updateMonthDisplay() {&#10;        String[] months = {&quot;Month 1&quot;, &quot;Month 2&quot;, &quot;Month 3&quot;, &quot;Month 4&quot;, &quot;Month 5&quot;, &quot;Month 6&quot;,&#10;                &quot;Month 7&quot;, &quot;Month 8&quot;, &quot;Month 9&quot;, &quot;Month 10&quot;, &quot;Month 11&quot;, &quot;Month 12&quot;};&#10;        tvCurrentMonth.setText(String.format(Locale.getDefault(), &quot;%s %d&quot;, months[currentMonth - 1], currentYear));&#10;    }&#10;&#10;    private void showEmptyState(boolean isTotalBudgetEmpty) {&#10;        budgetItems.clear();&#10;        budgetAdapter.notifyDataSetChanged();&#10;        rvBudgetItems.setVisibility(View.GONE);&#10;        tvEmptyState.setVisibility(View.VISIBLE);&#10;&#10;        if (isTotalBudgetEmpty) {&#10;            tvTotalBudget.setText(CurrencyUtils.formatCurrency(requireContext(), 0));&#10;            tvTotalSpent.setText(CurrencyUtils.formatCurrency(requireContext(), 0));&#10;            tvRemaining.setText(CurrencyUtils.formatCurrency(requireContext(), 0));&#10;            budgetProgressBar.setProgress(0);&#10;        }&#10;    }&#10;&#10;    private void changeMonth(int direction) {&#10;        currentMonth += direction;&#10;        if (currentMonth &lt; 1) {&#10;            currentMonth = 12;&#10;            currentYear--;&#10;        } else if (currentMonth &gt; 12) {&#10;            currentMonth = 1;&#10;            currentYear++;&#10;        }&#10;        Log.d(TAG, &quot;Month changed to: &quot; + currentMonth + &quot;/&quot; + currentYear);&#10;        loadBudgetData();&#10;    }&#10;&#10;    private void openAddBudgetActivity() {&#10;        Intent intent = new Intent(getActivity(), AddBudgetActivity.class);&#10;        startActivityForResult(intent, ADD_BUDGET_REQUEST_CODE);&#10;    }&#10;&#10;    @Override&#10;    public void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {&#10;        super.onActivityResult(requestCode, resultCode, data);&#10;&#10;        if (requestCode == ADD_BUDGET_REQUEST_CODE &amp;&amp; resultCode == Activity.RESULT_OK &amp;&amp; data != null) {&#10;            Log.d(TAG, &quot;✓ Received result from AddBudgetActivity&quot;);&#10;&#10;            int createdBudgetId = data.getIntExtra(AddBudgetActivity.EXTRA_BUDGET_ID, -1);&#10;            if (createdBudgetId &gt; 0) {&#10;                Log.d(TAG, &quot;Loading newly created budget ID: &quot; + createdBudgetId);&#10;                currentBudget = budgetRepository.getBudgetById(createdBudgetId);&#10;                if (currentBudget != null) {&#10;                    currentMonth = currentBudget.getMonth();&#10;                    currentYear = currentBudget.getYear();&#10;&#10;                    Log.d(TAG, &quot;✓ Loaded new budget: &quot; + currentMonth + &quot;/&quot; + currentYear);&#10;                    loadBudgetData();&#10;                    return;&#10;                }&#10;            }&#10;&#10;            // ✅ Fallback: Dùng tháng/năm từ intent&#10;            int newMonth = data.getIntExtra(AddBudgetActivity.EXTRA_MONTH, currentMonth);&#10;            int newYear = data.getIntExtra(AddBudgetActivity.EXTRA_YEAR, currentYear);&#10;&#10;            currentMonth = newMonth;&#10;            currentYear = newYear;&#10;&#10;            Log.d(TAG, &quot;Jumping to month: &quot; + currentMonth + &quot;/&quot; + currentYear);&#10;            loadBudgetData();&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void onEdit(BudgetItem item) {&#10;        showEditDialog(item);&#10;    }&#10;&#10;&#10;    private void showEditDialog(final BudgetItem item) {&#10;        AlertDialog.Builder builder = new AlertDialog.Builder(requireContext());&#10;        builder.setTitle(&quot;Edit budget for &quot; + item.getCategoryName());&#10;&#10;        final EditText input = new EditText(getContext());&#10;        input.setInputType(android.text.InputType.TYPE_CLASS_NUMBER);&#10;        input.setText(String.valueOf((int) item.getAllocatedAmount()));&#10;        input.setHint(&quot;Enter amount&quot;);&#10;&#10;        builder.setView(input);&#10;        builder.setPositiveButton(&quot;Save&quot;, (dialog, which) -&gt; {&#10;            String newAmount = input.getText().toString();&#10;            if (!newAmount.isEmpty()) {&#10;                try {&#10;                    double amount = Double.parseDouble(newAmount);&#10;                    item.setAllocatedAmount(amount);&#10;                    if (budgetItemRepository.updateBudgetItem(item)) {&#10;                        Toast.makeText(getContext(), &quot;✅ Update successful&quot;, Toast.LENGTH_SHORT).show();&#10;                        loadBudgetData();&#10;                    } else {&#10;                        Toast.makeText(getContext(), &quot;❌ Update failed&quot;, Toast.LENGTH_SHORT).show();&#10;                    }&#10;                } catch (NumberFormatException e) {&#10;                    Toast.makeText(getContext(), &quot;❌ Invalid amount&quot;, Toast.LENGTH_SHORT).show();&#10;                }&#10;            }&#10;        });&#10;        builder.setNegativeButton(&quot;Cancel&quot;, null);&#10;        builder.show();&#10;    }&#10;&#10;    @Override&#10;    public void onResume() {&#10;        super.onResume();&#10;        Log.d(TAG, &quot;✓ onResume - Reloading budget data&quot;);&#10;        loadBudgetData();  // ✅ Reload khi quay lại fragment&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.campusexpensesmanagermer.Fragments;&#13;&#10;&#13;&#10;import android.app.Activity;&#13;&#10;import android.content.Intent;&#13;&#10;import android.content.SharedPreferences;&#13;&#10;import android.os.Bundle;&#13;&#10;import android.util.Log;&#13;&#10;import android.view.LayoutInflater;&#13;&#10;import android.view.View;&#13;&#10;import android.view.ViewGroup;&#13;&#10;import android.widget.Button;&#13;&#10;import android.widget.EditText;&#13;&#10;import android.widget.ProgressBar;&#13;&#10;import android.widget.TextView;&#13;&#10;import android.widget.Toast;&#13;&#10;&#13;&#10;import androidx.annotation.Nullable;&#13;&#10;import androidx.appcompat.app.AlertDialog;&#13;&#10;import androidx.core.content.ContextCompat;&#13;&#10;import androidx.fragment.app.Fragment;&#13;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#13;&#10;import androidx.recyclerview.widget.RecyclerView;&#13;&#10;&#13;&#10;import com.example.campusexpensesmanagermer.Activities.Budgets.AddBudgetActivity;&#13;&#10;import com.example.campusexpensesmanagermer.Adapters.BudgetAdapter;&#13;&#10;import com.example.campusexpensesmanagermer.Models.Budget;&#13;&#10;import com.example.campusexpensesmanagermer.Models.BudgetItem;&#13;&#10;import com.example.campusexpensesmanagermer.R;&#13;&#10;import com.example.campusexpensesmanagermer.Utils.CurrencyUtils;&#13;&#10;import com.example.campusexpensesmanagermer.Repositories.BudgetRepository;&#13;&#10;import com.example.campusexpensesmanagermer.Repositories.BudgetItemRepository;&#13;&#10;import com.google.android.material.floatingactionbutton.FloatingActionButton;&#13;&#10;&#13;&#10;import java.util.ArrayList;&#13;&#10;import java.util.Calendar;&#13;&#10;import java.util.List;&#13;&#10;import java.util.Locale;&#13;&#10;&#13;&#10;public class BudgetFragment extends Fragment implements BudgetAdapter.OnBudgetItemClickListener {&#13;&#10;&#13;&#10;    private BudgetRepository budgetRepository;&#13;&#10;    private BudgetItemRepository budgetItemRepository;&#13;&#10;    private SharedPreferences prefs;&#13;&#10;    private int userId;&#13;&#10;&#13;&#10;    private TextView tvTotalBudget, tvTotalSpent, tvRemaining, tvEmptyState;&#13;&#10;    private ProgressBar budgetProgressBar;&#13;&#10;    private RecyclerView rvBudgetItems;&#13;&#10;    private BudgetAdapter budgetAdapter;&#13;&#10;    private List&lt;BudgetItem&gt; budgetItems;&#13;&#10;&#13;&#10;    private FloatingActionButton fabAddBudget;&#13;&#10;    private Button btnPrevMonth, btnNextMonth;&#13;&#10;    private TextView tvCurrentMonth;&#13;&#10;&#13;&#10;    private int currentMonth;&#13;&#10;    private int currentYear;&#13;&#10;    private Budget currentBudget;&#13;&#10;&#13;&#10;    private static final String PREFS_NAME = &quot;CampusExpensesPrefs&quot;;&#13;&#10;    private static final String TAG = &quot;BudgetFragment&quot;;&#13;&#10;    private static final int ADD_BUDGET_REQUEST_CODE = 1;&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public void onCreate(Bundle savedInstanceState) {&#13;&#10;        super.onCreate(savedInstanceState);&#13;&#10;        try {&#13;&#10;            budgetRepository = new BudgetRepository(getContext());&#13;&#10;            budgetItemRepository = new BudgetItemRepository(getContext());&#13;&#10;            prefs = requireActivity().getSharedPreferences(PREFS_NAME, 0);&#13;&#10;            userId = prefs.getInt(&quot;ID_USER&quot;, 0);&#13;&#10;&#13;&#10;            currentMonth = Calendar.getInstance().get(Calendar.MONTH) + 1;&#13;&#10;            currentYear = Calendar.getInstance().get(Calendar.YEAR);&#13;&#10;&#13;&#10;            Log.d(TAG, &quot;✓ onCreate - userId: &quot; + userId + &quot;, Current Month: &quot; + currentMonth + &quot;/&quot; + currentYear);&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error in onCreate: &quot; + e.getMessage(), e);&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public View onCreateView(LayoutInflater inflater, ViewGroup container,&#13;&#10;                             Bundle savedInstanceState) {&#13;&#10;        View view = inflater.inflate(R.layout.fragment_budget, container, false);&#13;&#10;&#13;&#10;        try {&#13;&#10;            initViews(view);&#13;&#10;            setupRecyclerView();&#13;&#10;            setupListeners();&#13;&#10;            loadBudgetData();&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error in onCreateView: &quot; + e.getMessage(), e);&#13;&#10;        }&#13;&#10;&#13;&#10;        return view;&#13;&#10;    }&#13;&#10;&#13;&#10;    private void initViews(View view) {&#13;&#10;        tvTotalBudget = view.findViewById(R.id.tv_total_budget);&#13;&#10;        tvTotalSpent = view.findViewById(R.id.tv_total_spent);&#13;&#10;        tvRemaining = view.findViewById(R.id.tv_remaining);&#13;&#10;        tvEmptyState = view.findViewById(R.id.tvEmptyState);&#13;&#10;        budgetProgressBar = view.findViewById(R.id.budget_progress_bar);&#13;&#10;        rvBudgetItems = view.findViewById(R.id.rv_budget_items);&#13;&#10;        fabAddBudget = view.findViewById(R.id.fab_add_budget);&#13;&#10;        btnPrevMonth = view.findViewById(R.id.btn_prev_month);&#13;&#10;        btnNextMonth = view.findViewById(R.id.btn_next_month);&#13;&#10;        tvCurrentMonth = view.findViewById(R.id.tv_current_month);&#13;&#10;    }&#13;&#10;&#13;&#10;    private void setupRecyclerView() {&#13;&#10;        budgetItems = new ArrayList&lt;&gt;();&#13;&#10;        budgetAdapter = new BudgetAdapter(getContext(), budgetItems);&#13;&#10;        budgetAdapter.setListener(this);&#13;&#10;&#13;&#10;        rvBudgetItems.setLayoutManager(new LinearLayoutManager(getContext()));&#13;&#10;        rvBudgetItems.setAdapter(budgetAdapter);&#13;&#10;    }&#13;&#10;&#13;&#10;    private void setupListeners() {&#13;&#10;        fabAddBudget.setOnClickListener(v -&gt; openAddBudgetActivity());&#13;&#10;        btnPrevMonth.setOnClickListener(v -&gt; changeMonth(-1));&#13;&#10;        btnNextMonth.setOnClickListener(v -&gt; changeMonth(1));&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * ✅ FIX: Load budget data với logic chính xác&#13;&#10;     */&#13;&#10;    private void loadBudgetData() {&#13;&#10;        if (userId == 0) {&#13;&#10;            Log.e(TAG, &quot;userId is 0, cannot load budget&quot;);&#13;&#10;            showEmptyState(true);&#13;&#10;            return;&#13;&#10;        }&#13;&#10;&#13;&#10;        try {&#13;&#10;            updateMonthDisplay();&#13;&#10;&#13;&#10;            // ✅ Lấy budget từ database&#13;&#10;            currentBudget = budgetRepository.getBudgetByUserAndMonth(userId, currentMonth, currentYear);&#13;&#10;&#13;&#10;            if (currentBudget == null) {&#13;&#10;                Log.d(TAG, &quot;No budget found for &quot; + currentMonth + &quot;/&quot; + currentYear);&#13;&#10;                showEmptyState(true);&#13;&#10;                return;&#13;&#10;            }&#13;&#10;&#13;&#10;            Log.d(TAG, &quot;✓ Budget loaded: Total=&quot; + currentBudget.getMoney() + &quot;, Spent=&quot; + currentBudget.getSpent());&#13;&#10;&#13;&#10;            // Load budget items&#13;&#10;            List&lt;BudgetItem&gt; items = budgetItemRepository.getBudgetItemsByBudget(currentBudget.getId());&#13;&#10;            budgetItems.clear();&#13;&#10;            budgetItems.addAll(items);&#13;&#10;            budgetAdapter.notifyDataSetChanged();&#13;&#10;&#13;&#10;            Log.d(TAG, &quot;✓ Loaded &quot; + items.size() + &quot; budget items&quot;);&#13;&#10;&#13;&#10;            // ✅ Tính tổng đã chi từ các mục (đảm bảo đồng bộ giữa tổng và danh mục)&#13;&#10;            double totalSpentFromItems = 0;&#13;&#10;            for (BudgetItem bi : items) {&#13;&#10;                totalSpentFromItems += bi.getSpentAmount();&#13;&#10;            }&#13;&#10;&#13;&#10;            // Nếu repository trả về giá trị khác (ví dụ tính từ express), ưu tiên giá trị từ DB (tổng các mục)&#13;&#10;            if (totalSpentFromItems &gt; 0) {&#13;&#10;                currentBudget.setSpent(totalSpentFromItems);&#13;&#10;            } else {&#13;&#10;                // Fallback: nếu không có mục hoặc tổng bằng 0 thì dùng giá trị tính sẵn&#13;&#10;                currentBudget.setSpent(budgetRepository.getTotalSpentByBudget(currentBudget.getId()));&#13;&#10;            }&#13;&#10;&#13;&#10;            // Hiển thị tổng ngân sách và đã chi sau khi đồng bộ&#13;&#10;            tvTotalBudget.setText(CurrencyUtils.formatCurrency(requireContext(), currentBudget.getMoney()));&#13;&#10;            tvTotalSpent.setText(CurrencyUtils.formatCurrency(requireContext(), currentBudget.getSpent()));&#13;&#10;            tvRemaining.setText(CurrencyUtils.formatCurrency(requireContext(), currentBudget.getRemaining()));&#13;&#10;&#13;&#10;            // ✅ Thay đổi màu nếu vượt quá&#13;&#10;            if (currentBudget.isExceeded()) {&#13;&#10;                tvRemaining.setTextColor(ContextCompat.getColor(requireContext(), android.R.color.holo_red_dark));&#13;&#10;                tvTotalSpent.setTextColor(ContextCompat.getColor(requireContext(), android.R.color.holo_red_dark));&#13;&#10;            } else {&#13;&#10;                tvRemaining.setTextColor(ContextCompat.getColor(requireContext(), android.R.color.holo_green_dark));&#13;&#10;                tvTotalSpent.setTextColor(ContextCompat.getColor(requireContext(), android.R.color.holo_orange_dark));&#13;&#10;            }&#13;&#10;&#13;&#10;            // ✅ Progress bar cập nhật theo tổng mới&#13;&#10;            budgetProgressBar.setProgress(currentBudget.getProgressPercentage());&#13;&#10;&#13;&#10;            // Allow editing main budget total by tapping the total text&#13;&#10;            tvTotalBudget.setOnClickListener(v -&gt; showEditBudgetTotalDialog());&#13;&#10;&#13;&#10;&#13;&#10;            if (items.isEmpty()) {&#13;&#10;                rvBudgetItems.setVisibility(View.GONE);&#13;&#10;                tvEmptyState.setVisibility(View.VISIBLE);&#13;&#10;            } else {&#13;&#10;                rvBudgetItems.setVisibility(View.VISIBLE);&#13;&#10;                tvEmptyState.setVisibility(View.GONE);&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error loading budget: &quot; + e.getMessage(), e);&#13;&#10;            showEmptyState(true);&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    private void updateMonthDisplay() {&#13;&#10;        String[] months = {&quot;Month 1&quot;, &quot;Month 2&quot;, &quot;Month 3&quot;, &quot;Month 4&quot;, &quot;Month 5&quot;, &quot;Month 6&quot;,&#13;&#10;                &quot;Month 7&quot;, &quot;Month 8&quot;, &quot;Month 9&quot;, &quot;Month 10&quot;, &quot;Month 11&quot;, &quot;Month 12&quot;};&#13;&#10;        tvCurrentMonth.setText(String.format(Locale.getDefault(), &quot;%s %d&quot;, months[currentMonth - 1], currentYear));&#13;&#10;    }&#13;&#10;&#13;&#10;    private void showEmptyState(boolean isTotalBudgetEmpty) {&#13;&#10;        budgetItems.clear();&#13;&#10;        budgetAdapter.notifyDataSetChanged();&#13;&#10;        rvBudgetItems.setVisibility(View.GONE);&#13;&#10;        tvEmptyState.setVisibility(View.VISIBLE);&#13;&#10;&#13;&#10;        if (isTotalBudgetEmpty) {&#13;&#10;            tvTotalBudget.setText(CurrencyUtils.formatCurrency(requireContext(), 0));&#13;&#10;            tvTotalSpent.setText(CurrencyUtils.formatCurrency(requireContext(), 0));&#13;&#10;            tvRemaining.setText(CurrencyUtils.formatCurrency(requireContext(), 0));&#13;&#10;            budgetProgressBar.setProgress(0);&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    private void changeMonth(int direction) {&#13;&#10;        currentMonth += direction;&#13;&#10;        if (currentMonth &lt; 1) {&#13;&#10;            currentMonth = 12;&#13;&#10;            currentYear--;&#13;&#10;        } else if (currentMonth &gt; 12) {&#13;&#10;            currentMonth = 1;&#13;&#10;            currentYear++;&#13;&#10;        }&#13;&#10;        Log.d(TAG, &quot;Month changed to: &quot; + currentMonth + &quot;/&quot; + currentYear);&#13;&#10;        loadBudgetData();&#13;&#10;    }&#13;&#10;&#13;&#10;    private void openAddBudgetActivity() {&#13;&#10;        Intent intent = new Intent(getActivity(), AddBudgetActivity.class);&#13;&#10;        startActivityForResult(intent, ADD_BUDGET_REQUEST_CODE);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {&#13;&#10;        super.onActivityResult(requestCode, resultCode, data);&#13;&#10;&#13;&#10;        if (requestCode == ADD_BUDGET_REQUEST_CODE &amp;&amp; resultCode == Activity.RESULT_OK &amp;&amp; data != null) {&#13;&#10;            Log.d(TAG, &quot;✓ Received result from AddBudgetActivity&quot;);&#13;&#10;&#13;&#10;            int createdBudgetId = data.getIntExtra(AddBudgetActivity.EXTRA_BUDGET_ID, -1);&#13;&#10;            if (createdBudgetId &gt; 0) {&#13;&#10;                Log.d(TAG, &quot;Loading newly created budget ID: &quot; + createdBudgetId);&#13;&#10;                currentBudget = budgetRepository.getBudgetById(createdBudgetId);&#13;&#10;                if (currentBudget != null) {&#13;&#10;                    currentMonth = currentBudget.getMonth();&#13;&#10;                    currentYear = currentBudget.getYear();&#13;&#10;&#13;&#10;                    Log.d(TAG, &quot;✓ Loaded new budget: &quot; + currentMonth + &quot;/&quot; + currentYear);&#13;&#10;                    loadBudgetData();&#13;&#10;                    return;&#13;&#10;                }&#13;&#10;            }&#13;&#10;&#13;&#10;            // ✅ Fallback: Dùng tháng/năm từ intent&#13;&#10;            int newMonth = data.getIntExtra(AddBudgetActivity.EXTRA_MONTH, currentMonth);&#13;&#10;            int newYear = data.getIntExtra(AddBudgetActivity.EXTRA_YEAR, currentYear);&#13;&#10;&#13;&#10;            currentMonth = newMonth;&#13;&#10;            currentYear = newYear;&#13;&#10;&#13;&#10;            Log.d(TAG, &quot;Jumping to month: &quot; + currentMonth + &quot;/&quot; + currentYear);&#13;&#10;            loadBudgetData();&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public void onEdit(BudgetItem item) {&#13;&#10;        showEditDialog(item);&#13;&#10;    }&#13;&#10;&#13;&#10;&#13;&#10;    private void showEditDialog(final BudgetItem item) {&#13;&#10;        AlertDialog.Builder builder = new AlertDialog.Builder(requireContext());&#13;&#10;        builder.setTitle(&quot;Edit budget for &quot; + item.getCategoryName());&#13;&#10;&#13;&#10;        final EditText input = new EditText(getContext());&#13;&#10;        input.setInputType(android.text.InputType.TYPE_CLASS_NUMBER);&#13;&#10;        input.setText(String.valueOf((int) item.getAllocatedAmount()));&#13;&#10;        input.setHint(&quot;Enter amount&quot;);&#13;&#10;&#13;&#10;        builder.setView(input);&#13;&#10;        builder.setPositiveButton(&quot;Save&quot;, (dialog, which) -&gt; {&#13;&#10;            String newAmount = input.getText().toString();&#13;&#10;            if (!newAmount.isEmpty()) {&#13;&#10;                try {&#13;&#10;                    double amount = Double.parseDouble(newAmount);&#13;&#10;                    item.setAllocatedAmount(amount);&#13;&#10;                    if (budgetItemRepository.updateBudgetItem(item)) {&#13;&#10;                        Toast.makeText(getContext(), &quot;✅ Update successful&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;                        loadBudgetData();&#13;&#10;                    } else {&#13;&#10;                        Toast.makeText(getContext(), &quot;❌ Update failed&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;                    }&#13;&#10;                } catch (NumberFormatException e) {&#13;&#10;                    Toast.makeText(getContext(), &quot;❌ Invalid amount&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;                }&#13;&#10;            }&#13;&#10;        });&#13;&#10;        builder.setNegativeButton(&quot;Cancel&quot;, null);&#13;&#10;        builder.show();&#13;&#10;    }&#13;&#10;&#13;&#10;    // Show dialog to edit the main budget total and re-split items&#13;&#10;    private void showEditBudgetTotalDialog() {&#13;&#10;        if (currentBudget == null || currentBudget.getId() == 0) return;&#13;&#10;&#13;&#10;        AlertDialog.Builder builder = new AlertDialog.Builder(requireContext());&#13;&#10;        builder.setTitle(&quot;Edit total budget&quot;);&#13;&#10;&#13;&#10;        final EditText input = new EditText(getContext());&#13;&#10;        input.setInputType(android.text.InputType.TYPE_CLASS_NUMBER | android.text.InputType.TYPE_NUMBER_FLAG_DECIMAL);&#13;&#10;        input.setText(String.valueOf(currentBudget.getMoney()));&#13;&#10;        input.setHint(&quot;Enter total amount&quot;);&#13;&#10;&#13;&#10;        builder.setView(input);&#13;&#10;        builder.setPositiveButton(&quot;Save&quot;, (dialog, which) -&gt; {&#13;&#10;            String val = input.getText().toString().trim();&#13;&#10;            if (val.isEmpty()) return;&#13;&#10;            try {&#13;&#10;                double newAmount = Double.parseDouble(val);&#13;&#10;                if (newAmount &lt;= 0) {&#13;&#10;                    Toast.makeText(getContext(), &quot;Invalid amount&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;                    return;&#13;&#10;                }&#13;&#10;&#13;&#10;                boolean ok = budgetRepository.updateBudgetAndSplit(currentBudget.getId(), newAmount);&#13;&#10;                if (ok) {&#13;&#10;                    Toast.makeText(getContext(), &quot;✅ Budget updated and split&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;                    loadBudgetData();&#13;&#10;                } else {&#13;&#10;                    Toast.makeText(getContext(), &quot;❌ Update failed&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;                }&#13;&#10;            } catch (NumberFormatException e) {&#13;&#10;                Toast.makeText(getContext(), &quot;❌ Invalid number&quot;, Toast.LENGTH_SHORT).show();&#13;&#10;            }&#13;&#10;        });&#13;&#10;        builder.setNegativeButton(&quot;Cancel&quot;, null);&#13;&#10;        builder.show();&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public void onResume() {&#13;&#10;        super.onResume();&#13;&#10;        Log.d(TAG, &quot;✓ onResume - Reloading budget data&quot;);&#13;&#10;        loadBudgetData();  // ✅ Reload khi quay lại fragment&#13;&#10;    }&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/campusexpensesmanagermer/Repositories/BudgetItemRepository.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/campusexpensesmanagermer/Repositories/BudgetItemRepository.java" />
              <option name="originalContent" value="package com.example.campusexpensesmanagermer.Repositories;&#10;&#10;import android.content.ContentValues;&#10;import android.content.Context;&#10;import android.database.Cursor;&#10;import android.database.sqlite.SQLiteDatabase;&#10;import android.util.Log;&#10;&#10;import com.example.campusexpensesmanagermer.Data.SQLiteDbHelper;&#10;import com.example.campusexpensesmanagermer.Models.BudgetItem;&#10;&#10;import java.text.SimpleDateFormat;&#10;import java.util.ArrayList;&#10;import java.util.Date;&#10;import java.util.List;&#10;import java.util.Locale;&#10;&#10;public class BudgetItemRepository {&#10;&#10;    private SQLiteDbHelper dbHelper;&#10;    private static final String TAG = &quot;BudgetItemRepository&quot;;&#10;&#10;    public BudgetItemRepository(Context context) {&#10;        dbHelper = new SQLiteDbHelper(context);&#10;    }&#10;&#10;    /**&#10;     * Thêm budget item&#10;     */&#10;    public long addBudgetItem(BudgetItem item) {&#10;        if (item == null) {&#10;            Log.e(TAG, &quot;BudgetItem object is null&quot;);&#10;            return -1;&#10;        }&#10;&#10;        SQLiteDatabase db = null;&#10;        try {&#10;            db = dbHelper.getWritableDatabase();&#10;            ContentValues values = new ContentValues();&#10;&#10;            values.put(SQLiteDbHelper.BUDGET_ID_ITEM, item.getBudgetId());&#10;            values.put(SQLiteDbHelper.CATEGORY_ID_ITEM, item.getCategoryName());&#10;            values.put(SQLiteDbHelper.ALLOCATED_AMOUNT_ITEM, item.getAllocatedAmount());&#10;&#10;            long id = db.insert(SQLiteDbHelper.TABLE_BUDGET_ITEMS, null, values);&#10;            Log.d(TAG, &quot;✓ Insert budget item success - ID: &quot; + id + &quot;, Category: &quot; + item.getCategoryName());&#10;            return id;&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error adding budget item: &quot; + e.getMessage());&#10;            e.printStackTrace();&#10;            return -1;&#10;        } finally {&#10;            if (db != null) {&#10;                db.close();&#10;            }&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Lấy budget item theo ID&#10;     */&#10;    public BudgetItem getBudgetItemById(int itemId) {&#10;        SQLiteDatabase db = null;&#10;        Cursor cursor = null;&#10;        try {&#10;            db = dbHelper.getReadableDatabase();&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGET_ITEMS +&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.ID_BUDGET_ITEM + &quot; = ?&quot;;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(itemId)});&#10;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#10;                return cursorToBudgetItem(cursor);&#10;            }&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error getting budget item: &quot; + e.getMessage());&#10;        } finally {&#10;            if (cursor != null) cursor.close();&#10;            if (db != null) db.close();&#10;        }&#10;        return null;&#10;    }&#10;&#10;    /**&#10;     * Lấy tất cả budget items của một budget&#10;     */&#10;    public List&lt;BudgetItem&gt; getBudgetItemsByBudget(int budgetId) {&#10;        List&lt;BudgetItem&gt; list = new ArrayList&lt;&gt;();&#10;        SQLiteDatabase db = null;&#10;        Cursor cursor = null;&#10;&#10;        try {&#10;            db = dbHelper.getReadableDatabase();&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGET_ITEMS +&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.BUDGET_ID_ITEM + &quot; = ?&quot;;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(budgetId)});&#10;&#10;            if (cursor != null &amp;&amp; cursor.getCount() &gt; 0) {&#10;                while (cursor.moveToNext()) {&#10;                    BudgetItem item = cursorToBudgetItem(cursor);&#10;                    // ✅ FIX: Tính spent amount cho category này&#10;                    item.setSpentAmount(getSpentAmountByCategory(budgetId, item.getCategoryName()));&#10;                    list.add(item);&#10;                }&#10;                Log.d(TAG, &quot;✓ Loaded &quot; + list.size() + &quot; budget items for budget: &quot; + budgetId);&#10;            }&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error getting budget items: &quot; + e.getMessage());&#10;        } finally {&#10;            if (cursor != null) cursor.close();&#10;            if (db != null) db.close();&#10;        }&#10;&#10;        return list;&#10;    }&#10;&#10;    /**&#10;     * ✅ FIX: Lấy spent amount cho một category trong budget&#10;     * Sử dụng TRIM() để tránh khoảng trắng&#10;     */&#10;    private double getSpentAmountByCategory(int budgetId, String categoryName) {&#10;        SQLiteDatabase db = null;&#10;        Cursor cursor = null;&#10;        try {&#10;            db = dbHelper.getReadableDatabase();&#10;&#10;            // Lấy thông tin budget để biết month/year&#10;            String budgetQuery = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGETS +&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.ID_BUDGET + &quot; = ?&quot;;&#10;            Cursor budgetCursor = db.rawQuery(budgetQuery, new String[]{String.valueOf(budgetId)});&#10;&#10;            if (budgetCursor == null || !budgetCursor.moveToFirst()) {&#10;                if (budgetCursor != null) budgetCursor.close();&#10;                return 0;&#10;            }&#10;&#10;            int year = budgetCursor.getInt(budgetCursor.getColumnIndexOrThrow(SQLiteDbHelper.YEAR_BUDGET));&#10;            int month = budgetCursor.getInt(budgetCursor.getColumnIndexOrThrow(SQLiteDbHelper.MONTH_BUDGET));&#10;            int userId = budgetCursor.getInt(budgetCursor.getColumnIndexOrThrow(SQLiteDbHelper.USER_ID_BUDGET));&#10;            budgetCursor.close();&#10;&#10;            // ✅ FIX: So sánh chính xác CATEGORY_ID_EXPRESS với TRIM()&#10;            String query = &quot;SELECT COALESCE(SUM(&quot; + SQLiteDbHelper.AMOUNT_EXPRESS + &quot;), 0) as total &quot; +&#10;                    &quot;FROM &quot; + SQLiteDbHelper.TABLE_EXPRESS +&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.USER_ID_EXPRESS + &quot; = ? &quot; +&#10;                    &quot;AND TRIM(&quot; + SQLiteDbHelper.CATEGORY_ID_EXPRESS + &quot;) = TRIM(?) &quot; +&#10;                    &quot;AND strftime('%Y', &quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ? &quot; +&#10;                    &quot;AND strftime('%m', &quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ?&quot;;&#10;&#10;            cursor = db.rawQuery(query, new String[]{&#10;                    String.valueOf(userId),&#10;                    categoryName.trim(),  // ✅ Trim ở đây&#10;                    String.valueOf(year),&#10;                    String.format(&quot;%02d&quot;, month)&#10;            });&#10;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#10;                double result = cursor.getDouble(0);&#10;                Log.d(TAG, &quot;Spent for category '&quot; + categoryName + &quot;' in &quot; + month + &quot;/&quot; + year + &quot;: &quot; + result);&#10;                return result;&#10;            }&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error getting spent amount: &quot; + e.getMessage());&#10;        } finally {&#10;            if (cursor != null) cursor.close();&#10;            if (db != null) db.close();&#10;        }&#10;&#10;        return 0;&#10;    }&#10;&#10;    /**&#10;     * Cập nhật budget item&#10;     */&#10;    public boolean updateBudgetItem(BudgetItem item) {&#10;        if (item == null || item.getId() == 0) {&#10;            Log.e(TAG, &quot;Invalid budget item for update&quot;);&#10;            return false;&#10;        }&#10;&#10;        SQLiteDatabase db = null;&#10;        try {&#10;            db = dbHelper.getWritableDatabase();&#10;            ContentValues values = new ContentValues();&#10;            values.put(SQLiteDbHelper.ALLOCATED_AMOUNT_ITEM, item.getAllocatedAmount());&#10;&#10;            int result = db.update(&#10;                    SQLiteDbHelper.TABLE_BUDGET_ITEMS,&#10;                    values,&#10;                    SQLiteDbHelper.ID_BUDGET_ITEM + &quot; = ?&quot;,&#10;                    new String[]{String.valueOf(item.getId())}&#10;            );&#10;&#10;            boolean success = result &gt; 0;&#10;            Log.d(TAG, success ? &quot;✓ Update budget item success&quot; : &quot;✗ Update budget item failed&quot;);&#10;            return success;&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error updating budget item: &quot; + e.getMessage());&#10;            return false;&#10;        } finally {&#10;            if (db != null) db.close();&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Xóa budget item&#10;     */&#10;    public boolean deleteBudgetItem(int itemId) {&#10;        SQLiteDatabase db = null;&#10;        try {&#10;            db = dbHelper.getWritableDatabase();&#10;            int result = db.delete(&#10;                    SQLiteDbHelper.TABLE_BUDGET_ITEMS,&#10;                    SQLiteDbHelper.ID_BUDGET_ITEM + &quot; = ?&quot;,&#10;                    new String[]{String.valueOf(itemId)}&#10;            );&#10;&#10;            boolean success = result &gt; 0;&#10;            Log.d(TAG, success ? &quot;✓ Delete budget item success&quot; : &quot;✗ Delete budget item failed&quot;);&#10;            return success;&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error deleting budget item: &quot; + e.getMessage());&#10;            return false;&#10;        } finally {&#10;            if (db != null) db.close();&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Xóa tất cả budget items của một budget&#10;     */&#10;    public boolean deleteBudgetItemsByBudget(int budgetId) {&#10;        SQLiteDatabase db = null;&#10;        try {&#10;            db = dbHelper.getWritableDatabase();&#10;            int result = db.delete(&#10;                    SQLiteDbHelper.TABLE_BUDGET_ITEMS,&#10;                    SQLiteDbHelper.BUDGET_ID_ITEM + &quot; = ?&quot;,&#10;                    new String[]{String.valueOf(budgetId)}&#10;            );&#10;&#10;            boolean success = result &gt; 0;&#10;            Log.d(TAG, success ? &quot;✓ Delete all budget items success&quot; : &quot;✗ Delete all budget items failed&quot;);&#10;            return success;&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error deleting budget items: &quot; + e.getMessage());&#10;            return false;&#10;        } finally {&#10;            if (db != null) db.close();&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Helper: Convert cursor to BudgetItem&#10;     */&#10;    private BudgetItem cursorToBudgetItem(Cursor cursor) {&#10;        BudgetItem item = new BudgetItem();&#10;        item.setId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ID_BUDGET_ITEM)));&#10;        item.setBudgetId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.BUDGET_ID_ITEM)));&#10;        item.setCategoryName(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.CATEGORY_ID_ITEM)));&#10;        item.setAllocatedAmount(cursor.getDouble(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ALLOCATED_AMOUNT_ITEM)));&#10;        item.setCreatedAt(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.CREATED_AT)));&#10;        return item;&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.campusexpensesmanagermer.Repositories;&#13;&#10;&#13;&#10;import android.content.ContentValues;&#13;&#10;import android.content.Context;&#13;&#10;import android.database.Cursor;&#13;&#10;import android.database.sqlite.SQLiteDatabase;&#13;&#10;import android.util.Log;&#13;&#10;&#13;&#10;import com.example.campusexpensesmanagermer.Data.SQLiteDbHelper;&#13;&#10;import com.example.campusexpensesmanagermer.Models.BudgetItem;&#13;&#10;&#13;&#10;import java.text.SimpleDateFormat;&#13;&#10;import java.util.ArrayList;&#13;&#10;import java.util.Date;&#13;&#10;import java.util.List;&#13;&#10;import java.util.Locale;&#13;&#10;&#13;&#10;public class BudgetItemRepository {&#13;&#10;&#13;&#10;    private SQLiteDbHelper dbHelper;&#13;&#10;    private static final String TAG = &quot;BudgetItemRepository&quot;;&#13;&#10;&#13;&#10;    public BudgetItemRepository(Context context) {&#13;&#10;        dbHelper = new SQLiteDbHelper(context);&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Thêm budget item&#13;&#10;     */&#13;&#10;    public long addBudgetItem(BudgetItem item) {&#13;&#10;        if (item == null) {&#13;&#10;            Log.e(TAG, &quot;BudgetItem object is null&quot;);&#13;&#10;            return -1;&#13;&#10;        }&#13;&#10;&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getWritableDatabase();&#13;&#10;            ContentValues values = new ContentValues();&#13;&#10;&#13;&#10;            values.put(SQLiteDbHelper.BUDGET_ID_ITEM, item.getBudgetId());&#13;&#10;            values.put(SQLiteDbHelper.CATEGORY_ID_ITEM, item.getCategoryName());&#13;&#10;            values.put(SQLiteDbHelper.ALLOCATED_AMOUNT_ITEM, item.getAllocatedAmount());&#13;&#10;&#13;&#10;            long id = db.insert(SQLiteDbHelper.TABLE_BUDGET_ITEMS, null, values);&#13;&#10;            Log.d(TAG, &quot;✓ Insert budget item success - ID: &quot; + id + &quot;, Category: &quot; + item.getCategoryName());&#13;&#10;            return id;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error adding budget item: &quot; + e.getMessage());&#13;&#10;            e.printStackTrace();&#13;&#10;            return -1;&#13;&#10;        } finally {&#13;&#10;            if (db != null) {&#13;&#10;                db.close();&#13;&#10;            }&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Lấy budget item theo ID&#13;&#10;     */&#13;&#10;    public BudgetItem getBudgetItemById(int itemId) {&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        Cursor cursor = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getReadableDatabase();&#13;&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGET_ITEMS +&#13;&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.ID_BUDGET_ITEM + &quot; = ?&quot;;&#13;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(itemId)});&#13;&#10;&#13;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#13;&#10;                return cursorToBudgetItem(cursor);&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error getting budget item: &quot; + e.getMessage());&#13;&#10;        } finally {&#13;&#10;            if (cursor != null) cursor.close();&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;        return null;&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Lấy tất cả budget items của một budget&#13;&#10;     */&#13;&#10;    public List&lt;BudgetItem&gt; getBudgetItemsByBudget(int budgetId) {&#13;&#10;        List&lt;BudgetItem&gt; list = new ArrayList&lt;&gt;();&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        Cursor cursor = null;&#13;&#10;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getReadableDatabase();&#13;&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGET_ITEMS +&#13;&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.BUDGET_ID_ITEM + &quot; = ?&quot;;&#13;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(budgetId)});&#13;&#10;&#13;&#10;            if (cursor != null &amp;&amp; cursor.getCount() &gt; 0) {&#13;&#10;                while (cursor.moveToNext()) {&#13;&#10;                    BudgetItem item = cursorToBudgetItem(cursor);&#13;&#10;                    // ✅ FIX: Tính spent amount cho category này&#13;&#10;                    item.setSpentAmount(getSpentAmountByCategory(budgetId, item.getCategoryName()));&#13;&#10;                    list.add(item);&#13;&#10;                }&#13;&#10;                Log.d(TAG, &quot;✓ Loaded &quot; + list.size() + &quot; budget items for budget: &quot; + budgetId);&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error getting budget items: &quot; + e.getMessage());&#13;&#10;        } finally {&#13;&#10;            if (cursor != null) cursor.close();&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;&#13;&#10;        return list;&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * ✅ FIX: Lấy spent amount cho một category trong budget&#13;&#10;     * Sử dụng TRIM() để tránh khoảng trắng&#13;&#10;     */&#13;&#10;    private double getSpentAmountByCategory(int budgetId, String categoryName) {&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        Cursor cursor = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getReadableDatabase();&#13;&#10;&#13;&#10;            // Lấy thông tin budget để biết month/year&#13;&#10;            String budgetQuery = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGETS +&#13;&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.ID_BUDGET + &quot; = ?&quot;;&#13;&#10;            Cursor budgetCursor = db.rawQuery(budgetQuery, new String[]{String.valueOf(budgetId)});&#13;&#10;&#13;&#10;            if (budgetCursor == null || !budgetCursor.moveToFirst()) {&#13;&#10;                if (budgetCursor != null) budgetCursor.close();&#13;&#10;                return 0;&#13;&#10;            }&#13;&#10;&#13;&#10;            int year = budgetCursor.getInt(budgetCursor.getColumnIndexOrThrow(SQLiteDbHelper.YEAR_BUDGET));&#13;&#10;            int month = budgetCursor.getInt(budgetCursor.getColumnIndexOrThrow(SQLiteDbHelper.MONTH_BUDGET));&#13;&#10;            int userId = budgetCursor.getInt(budgetCursor.getColumnIndexOrThrow(SQLiteDbHelper.USER_ID_BUDGET));&#13;&#10;            budgetCursor.close();&#13;&#10;&#13;&#10;            // ✅ FIX: So sánh chính xác CATEGORY_ID_EXPRESS với TRIM()&#13;&#10;            String query = &quot;SELECT COALESCE(SUM(&quot; + SQLiteDbHelper.AMOUNT_EXPRESS + &quot;), 0) as total &quot; +&#13;&#10;                    &quot;FROM &quot; + SQLiteDbHelper.TABLE_EXPRESS +&#13;&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.USER_ID_EXPRESS + &quot; = ? &quot; +&#13;&#10;                    &quot;AND TRIM(&quot; + SQLiteDbHelper.CATEGORY_ID_EXPRESS + &quot;) = TRIM(?) &quot; +&#13;&#10;                    &quot;AND strftime('%Y', &quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ? &quot; +&#13;&#10;                    &quot;AND strftime('%m', &quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ?&quot;;&#13;&#10;&#13;&#10;            cursor = db.rawQuery(query, new String[]{&#13;&#10;                    String.valueOf(userId),&#13;&#10;                    categoryName.trim(),  // ✅ Trim ở đây&#13;&#10;                    String.valueOf(year),&#13;&#10;                    String.format(&quot;%02d&quot;, month)&#13;&#10;            });&#13;&#10;&#13;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#13;&#10;                double result = cursor.getDouble(0);&#13;&#10;                Log.d(TAG, &quot;Spent for category '&quot; + categoryName + &quot;' in &quot; + month + &quot;/&quot; + year + &quot;: &quot; + result);&#13;&#10;                return result;&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error getting spent amount: &quot; + e.getMessage());&#13;&#10;        } finally {&#13;&#10;            if (cursor != null) cursor.close();&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;&#13;&#10;        return 0;&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Cập nhật budget item&#13;&#10;     */&#13;&#10;    public boolean updateBudgetItem(BudgetItem item) {&#13;&#10;        if (item == null || item.getId() == 0) {&#13;&#10;            Log.e(TAG, &quot;Invalid budget item for update&quot;);&#13;&#10;            return false;&#13;&#10;        }&#13;&#10;&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getWritableDatabase();&#13;&#10;            ContentValues values = new ContentValues();&#13;&#10;            values.put(SQLiteDbHelper.ALLOCATED_AMOUNT_ITEM, item.getAllocatedAmount());&#13;&#10;&#13;&#10;            int result = db.update(&#13;&#10;                    SQLiteDbHelper.TABLE_BUDGET_ITEMS,&#13;&#10;                    values,&#13;&#10;                    SQLiteDbHelper.ID_BUDGET_ITEM + &quot; = ?&quot;,&#13;&#10;                    new String[]{String.valueOf(item.getId())}&#13;&#10;            );&#13;&#10;&#13;&#10;            boolean success = result &gt; 0;&#13;&#10;            Log.d(TAG, success ? &quot;✓ Update budget item success&quot; : &quot;✗ Update budget item failed&quot;);&#13;&#10;            return success;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error updating budget item: &quot; + e.getMessage());&#13;&#10;            return false;&#13;&#10;        } finally {&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Xóa budget item&#13;&#10;     */&#13;&#10;    public boolean deleteBudgetItem(int itemId) {&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getWritableDatabase();&#13;&#10;            int result = db.delete(&#13;&#10;                    SQLiteDbHelper.TABLE_BUDGET_ITEMS,&#13;&#10;                    SQLiteDbHelper.ID_BUDGET_ITEM + &quot; = ?&quot;,&#13;&#10;                    new String[]{String.valueOf(itemId)}&#13;&#10;            );&#13;&#10;&#13;&#10;            boolean success = result &gt; 0;&#13;&#10;            Log.d(TAG, success ? &quot;✓ Delete budget item success&quot; : &quot;✗ Delete budget item failed&quot;);&#13;&#10;            return success;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error deleting budget item: &quot; + e.getMessage());&#13;&#10;            return false;&#13;&#10;        } finally {&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Xóa tất cả budget items của một budget&#13;&#10;     */&#13;&#10;    public boolean deleteBudgetItemsByBudget(int budgetId) {&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getWritableDatabase();&#13;&#10;            int result = db.delete(&#13;&#10;                    SQLiteDbHelper.TABLE_BUDGET_ITEMS,&#13;&#10;                    SQLiteDbHelper.BUDGET_ID_ITEM + &quot; = ?&quot;,&#13;&#10;                    new String[]{String.valueOf(budgetId)}&#13;&#10;            );&#13;&#10;&#13;&#10;            boolean success = result &gt; 0;&#13;&#10;            Log.d(TAG, success ? &quot;✓ Delete all budget items success&quot; : &quot;✗ Delete all budget items failed&quot;);&#13;&#10;            return success;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error deleting budget items: &quot; + e.getMessage());&#13;&#10;            return false;&#13;&#10;        } finally {&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Thêm nhiều budget items trong cùng một transaction&#13;&#10;     */&#13;&#10;    public boolean addBudgetItemsInTransaction(List&lt;BudgetItem&gt; items) {&#13;&#10;        if (items == null || items.isEmpty()) {&#13;&#10;            Log.e(TAG, &quot;No items to insert&quot;);&#13;&#10;            return false;&#13;&#10;        }&#13;&#10;&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getWritableDatabase();&#13;&#10;            db.beginTransaction();&#13;&#10;&#13;&#10;            for (BudgetItem item : items) {&#13;&#10;                ContentValues values = new ContentValues();&#13;&#10;                values.put(SQLiteDbHelper.BUDGET_ID_ITEM, item.getBudgetId());&#13;&#10;                values.put(SQLiteDbHelper.CATEGORY_ID_ITEM, item.getCategoryName());&#13;&#10;                values.put(SQLiteDbHelper.ALLOCATED_AMOUNT_ITEM, item.getAllocatedAmount());&#13;&#10;&#13;&#10;                long id = db.insert(SQLiteDbHelper.TABLE_BUDGET_ITEMS, null, values);&#13;&#10;                if (id &lt;= 0) {&#13;&#10;                    Log.e(TAG, &quot;Failed to insert budget item: &quot; + item.getCategoryName());&#13;&#10;                    // continue to attempt others but mark as failure&#13;&#10;                } else {&#13;&#10;                    Log.d(TAG, &quot;✓ Inserted budget item in tx - ID: &quot; + id + &quot;, Category: &quot; + item.getCategoryName());&#13;&#10;                }&#13;&#10;            }&#13;&#10;&#13;&#10;            db.setTransactionSuccessful();&#13;&#10;            return true;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error inserting budget items in transaction: &quot; + e.getMessage(), e);&#13;&#10;            return false;&#13;&#10;        } finally {&#13;&#10;            if (db != null) {&#13;&#10;                try {&#13;&#10;                    db.endTransaction();&#13;&#10;                } catch (Exception ignored) {}&#13;&#10;                db.close();&#13;&#10;            }&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Helper: Convert cursor to BudgetItem&#13;&#10;     */&#13;&#10;    private BudgetItem cursorToBudgetItem(Cursor cursor) {&#13;&#10;        BudgetItem item = new BudgetItem();&#13;&#10;        item.setId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ID_BUDGET_ITEM)));&#13;&#10;        item.setBudgetId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.BUDGET_ID_ITEM)));&#13;&#10;        item.setCategoryName(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.CATEGORY_ID_ITEM)));&#13;&#10;        item.setAllocatedAmount(cursor.getDouble(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ALLOCATED_AMOUNT_ITEM)));&#13;&#10;        item.setCreatedAt(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.CREATED_AT)));&#13;&#10;        return item;&#13;&#10;    }&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/campusexpensesmanagermer/Repositories/BudgetRepository.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/campusexpensesmanagermer/Repositories/BudgetRepository.java" />
              <option name="originalContent" value="package com.example.campusexpensesmanagermer.Repositories;&#10;&#10;import android.content.ContentValues;&#10;import android.content.Context;&#10;import android.database.Cursor;&#10;import android.database.sqlite.SQLiteDatabase;&#10;import android.util.Log;&#10;&#10;import com.example.campusexpensesmanagermer.Data.SQLiteDbHelper;&#10;import com.example.campusexpensesmanagermer.Models.Budget;&#10;&#10;import java.text.SimpleDateFormat;&#10;import java.util.ArrayList;&#10;import java.util.Calendar;&#10;import java.util.Date;&#10;import java.util.List;&#10;import java.util.Locale;&#10;&#10;public class BudgetRepository {&#10;&#10;    private final SQLiteDbHelper dbHelper;&#10;    private static final String TAG = &quot;BudgetRepository&quot;;&#10;&#10;    public BudgetRepository(Context context) {&#10;        dbHelper = new SQLiteDbHelper(context);&#10;    }&#10;&#10;    /**&#10;     * Thêm ngân sách mới&#10;     */&#10;    public long addBudget(Budget budget) {&#10;        if (budget == null) {&#10;            Log.e(TAG, &quot;Budget object is null&quot;);&#10;            return -1;&#10;        }&#10;&#10;        SQLiteDatabase db = null;&#10;        try {&#10;            db = dbHelper.getWritableDatabase();&#10;            ContentValues values = new ContentValues();&#10;&#10;            values.put(SQLiteDbHelper.USER_ID_BUDGET, budget.getUserId());&#10;            values.put(SQLiteDbHelper.YEAR_BUDGET, budget.getYear() &gt; 0 ? budget.getYear() : Calendar.getInstance().get(Calendar.YEAR));&#10;            values.put(SQLiteDbHelper.MONTH_BUDGET, budget.getMonth() &gt; 0 ? budget.getMonth() : Calendar.getInstance().get(Calendar.MONTH) + 1);&#10;            values.put(SQLiteDbHelper.TARGET_AMOUNT_BUDGET, budget.getMoney());&#10;            values.put(SQLiteDbHelper.CURRENCY_BUDGET, &quot;VND&quot;);&#10;            values.put(SQLiteDbHelper.NOTE_BUDGET, budget.getDescription());&#10;&#10;            long id = db.insert(SQLiteDbHelper.TABLE_BUDGETS, null, values);&#10;            Log.d(TAG, &quot;✓ Insert budget success - ID: &quot; + id + &quot;, UserId: &quot; + budget.getUserId()&#10;                    + &quot;, Month: &quot; + budget.getMonth() + &quot;, Year: &quot; + budget.getYear()&#10;                    + &quot;, Amount: &quot; + budget.getMoney());&#10;            return id;&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error adding budget: &quot; + e.getMessage(), e);&#10;            return -1;&#10;        } finally {&#10;            if (db != null) {&#10;                db.close();&#10;            }&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Lấy ngân sách theo ID&#10;     */&#10;    public Budget getBudgetById(int budgetId) {&#10;        SQLiteDatabase db = null;&#10;        Cursor cursor = null;&#10;        try {&#10;            db = dbHelper.getReadableDatabase();&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGETS +&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.ID_BUDGET + &quot; = ?&quot;;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(budgetId)});&#10;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#10;                Budget budget = new Budget();&#10;                budget.setId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ID_BUDGET)));&#10;                budget.setUserId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.USER_ID_BUDGET)));&#10;                budget.setYear(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.YEAR_BUDGET)));&#10;                budget.setMonth(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.MONTH_BUDGET)));&#10;                budget.setMoney(cursor.getDouble(cursor.getColumnIndexOrThrow(SQLiteDbHelper.TARGET_AMOUNT_BUDGET)));&#10;                budget.setDescription(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.NOTE_BUDGET)));&#10;&#10;                Log.d(TAG, &quot;✓ Found budget ID: &quot; + budgetId);&#10;                return budget;&#10;            }&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error getting budget: &quot; + e.getMessage(), e);&#10;        } finally {&#10;            if (cursor != null) cursor.close();&#10;            if (db != null) db.close();&#10;        }&#10;        return null;&#10;    }&#10;&#10;    /**&#10;     * ✅ FIX: Lấy ngân sách theo tháng/năm&#10;     * Trả về budget mới nhất nếu có nhiều budget cho cùng tháng/năm&#10;     */&#10;    public Budget getBudgetByUserAndMonth(int userId, int month, int year) {&#10;        SQLiteDatabase db = null;&#10;        Cursor cursor = null;&#10;        try {&#10;            db = dbHelper.getReadableDatabase();&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGETS +&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.USER_ID_BUDGET + &quot; = ? &quot; +&#10;                    &quot;AND &quot; + SQLiteDbHelper.MONTH_BUDGET + &quot; = ? &quot; +&#10;                    &quot;AND &quot; + SQLiteDbHelper.YEAR_BUDGET + &quot; = ? &quot; +&#10;                    &quot;ORDER BY &quot; + SQLiteDbHelper.ID_BUDGET + &quot; DESC LIMIT 1&quot;;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(userId), String.valueOf(month), String.valueOf(year)});&#10;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#10;                Budget budget = new Budget();&#10;                budget.setId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ID_BUDGET)));&#10;                budget.setUserId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.USER_ID_BUDGET)));&#10;                budget.setYear(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.YEAR_BUDGET)));&#10;                budget.setMonth(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.MONTH_BUDGET)));&#10;                budget.setMoney(cursor.getDouble(cursor.getColumnIndexOrThrow(SQLiteDbHelper.TARGET_AMOUNT_BUDGET)));&#10;                budget.setDescription(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.NOTE_BUDGET)));&#10;&#10;                // ✅ FIX: Tính tổng chi tiêu chính xác&#10;                budget.setSpent(getTotalSpentByBudget(budget.getId()));&#10;&#10;                Log.d(TAG, &quot;✓ Found budget for &quot; + month + &quot;/&quot; + year + &quot; (userId=&quot; + userId&#10;                        + &quot;), Spent: &quot; + budget.getSpent());&#10;                return budget;&#10;            }&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error getting budget: &quot; + e.getMessage(), e);&#10;        } finally {&#10;            if (cursor != null) cursor.close();&#10;            if (db != null) db.close();&#10;        }&#10;        return null;&#10;    }&#10;&#10;    /**&#10;     * Lấy tất cả ngân sách của user&#10;     */&#10;    public List&lt;Budget&gt; getAllBudgetsByUser(int userId) {&#10;        List&lt;Budget&gt; list = new ArrayList&lt;&gt;();&#10;        SQLiteDatabase db = null;&#10;        Cursor cursor = null;&#10;&#10;        try {&#10;            db = dbHelper.getReadableDatabase();&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGETS +&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.USER_ID_BUDGET + &quot; = ? &quot; +&#10;                    &quot;ORDER BY &quot; + SQLiteDbHelper.YEAR_BUDGET + &quot; DESC, &quot; +&#10;                    SQLiteDbHelper.MONTH_BUDGET + &quot; DESC&quot;;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(userId)});&#10;&#10;            if (cursor != null &amp;&amp; cursor.getCount() &gt; 0) {&#10;                while (cursor.moveToNext()) {&#10;                    Budget budget = new Budget();&#10;                    budget.setId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ID_BUDGET)));&#10;                    budget.setUserId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.USER_ID_BUDGET)));&#10;                    budget.setYear(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.YEAR_BUDGET)));&#10;                    budget.setMonth(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.MONTH_BUDGET)));&#10;                    budget.setMoney(cursor.getDouble(cursor.getColumnIndexOrThrow(SQLiteDbHelper.TARGET_AMOUNT_BUDGET)));&#10;                    budget.setDescription(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.NOTE_BUDGET)));&#10;&#10;                    budget.setSpent(getTotalSpentByBudget(budget.getId()));&#10;                    list.add(budget);&#10;                }&#10;                Log.d(TAG, &quot;✓ Loaded &quot; + list.size() + &quot; budgets for userId: &quot; + userId);&#10;            }&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error getting budgets: &quot; + e.getMessage(), e);&#10;        } finally {&#10;            if (cursor != null) cursor.close();&#10;            if (db != null) db.close();&#10;        }&#10;&#10;        return list;&#10;    }&#10;&#10;    /**&#10;     * Cập nhật ngân sách&#10;     */&#10;    public boolean updateBudget(Budget budget) {&#10;        if (budget == null || budget.getId() == 0) {&#10;            Log.e(TAG, &quot;Invalid budget object for update&quot;);&#10;            return false;&#10;        }&#10;&#10;        SQLiteDatabase db = null;&#10;        try {&#10;            db = dbHelper.getWritableDatabase();&#10;            ContentValues values = new ContentValues();&#10;            values.put(SQLiteDbHelper.MONTH_BUDGET, budget.getMonth());&#10;            values.put(SQLiteDbHelper.YEAR_BUDGET, budget.getYear());&#10;            values.put(SQLiteDbHelper.TARGET_AMOUNT_BUDGET, budget.getMoney());&#10;            values.put(SQLiteDbHelper.NOTE_BUDGET, budget.getDescription());&#10;            values.put(SQLiteDbHelper.UPDATED_AT, new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.getDefault()).format(new Date()));&#10;&#10;            int result = db.update(&#10;                    SQLiteDbHelper.TABLE_BUDGETS,&#10;                    values,&#10;                    SQLiteDbHelper.ID_BUDGET + &quot; = ?&quot;,&#10;                    new String[]{String.valueOf(budget.getId())}&#10;            );&#10;&#10;            boolean success = result &gt; 0;&#10;            Log.d(TAG, success ? &quot;✓ Update budget success&quot; : &quot;✗ Update budget failed&quot;);&#10;            return success;&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error updating budget: &quot; + e.getMessage(), e);&#10;            return false;&#10;        } finally {&#10;            if (db != null) db.close();&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Xóa ngân sách&#10;     */&#10;    public boolean deleteBudget(int budgetId) {&#10;        SQLiteDatabase db = null;&#10;        try {&#10;            db = dbHelper.getWritableDatabase();&#10;&#10;            // Xóa budget items trước&#10;            db.delete(SQLiteDbHelper.TABLE_BUDGET_ITEMS,&#10;                    SQLiteDbHelper.BUDGET_ID_ITEM + &quot; = ?&quot;,&#10;                    new String[]{String.valueOf(budgetId)});&#10;&#10;            // Xóa budget&#10;            int result = db.delete(&#10;                    SQLiteDbHelper.TABLE_BUDGETS,&#10;                    SQLiteDbHelper.ID_BUDGET + &quot; = ?&quot;,&#10;                    new String[]{String.valueOf(budgetId)}&#10;            );&#10;&#10;            boolean success = result &gt; 0;&#10;            Log.d(TAG, success ? &quot;✓ Delete budget success&quot; : &quot;✗ Delete budget failed&quot;);&#10;            return success;&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error deleting budget: &quot; + e.getMessage(), e);&#10;            return false;&#10;        } finally {&#10;            if (db != null) db.close();&#10;        }&#10;    }&#10;&#10;    /**&#10;     * ✅ FIX: Tính tổng chi tiêu theo budget (sum của tất cả chi tiêu trong tháng/năm)&#10;     * Sử dụng TRIM() để so sánh chính xác category&#10;     */&#10;    public double getTotalSpentByBudget(int budgetId) {&#10;        SQLiteDatabase db = null;&#10;        Cursor cursor = null;&#10;        try {&#10;            db = dbHelper.getReadableDatabase();&#10;&#10;            Budget budget = getBudgetById(budgetId);&#10;            if (budget == null) {&#10;                return 0;&#10;            }&#10;&#10;            // ✅ FIX: Tính tổng chi tiêu từ express trong tháng/năm&#10;            String query = &quot;SELECT COALESCE(SUM(e.&quot; + SQLiteDbHelper.AMOUNT_EXPRESS + &quot;), 0) as total &quot; +&#10;                    &quot;FROM &quot; + SQLiteDbHelper.TABLE_EXPRESS + &quot; e &quot; +&#10;                    &quot;WHERE e.&quot; + SQLiteDbHelper.USER_ID_EXPRESS + &quot; = ? &quot; +&#10;                    &quot;AND strftime('%Y', e.&quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ? &quot; +&#10;                    &quot;AND strftime('%m', e.&quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ?&quot;;&#10;&#10;            cursor = db.rawQuery(query, new String[]{&#10;                    String.valueOf(budget.getUserId()),&#10;                    String.valueOf(budget.getYear()),&#10;                    String.format(Locale.getDefault(), &quot;%02d&quot;, budget.getMonth())&#10;            });&#10;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#10;                double total = cursor.getDouble(0);&#10;                Log.d(TAG, &quot;Total spent for budget &quot; + budgetId + &quot; (&quot; + budget.getMonth()&#10;                        + &quot;/&quot; + budget.getYear() + &quot;): &quot; + total);&#10;                return total;&#10;            }&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error calculating total spent: &quot; + e.getMessage(), e);&#10;        } finally {&#10;            if (cursor != null) cursor.close();&#10;            if (db != null) db.close();&#10;        }&#10;&#10;        return 0;&#10;    }&#10;&#10;    /**&#10;     * ✅ FIX: Tính chi tiêu theo category&#10;     * Sử dụng TRIM() để so sánh chính xác&#10;     */&#10;    public double getSpentByCategory(int budgetId, String categoryName) {&#10;        SQLiteDatabase db = null;&#10;        Cursor cursor = null;&#10;        try {&#10;            db = dbHelper.getReadableDatabase();&#10;            Budget budget = getBudgetById(budgetId);&#10;            if (budget == null) return 0;&#10;&#10;            String query = &quot;SELECT COALESCE(SUM(e.&quot; + SQLiteDbHelper.AMOUNT_EXPRESS + &quot;), 0) as total &quot; +&#10;                    &quot;FROM &quot; + SQLiteDbHelper.TABLE_EXPRESS + &quot; e &quot; +&#10;                    &quot;WHERE e.&quot; + SQLiteDbHelper.USER_ID_EXPRESS + &quot; = ? &quot; +&#10;                    &quot;AND TRIM(e.&quot; + SQLiteDbHelper.CATEGORY_ID_EXPRESS + &quot;) = TRIM(?) &quot; +&#10;                    &quot;AND strftime('%Y', e.&quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ? &quot; +&#10;                    &quot;AND strftime('%m', e.&quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ?&quot;;&#10;&#10;            cursor = db.rawQuery(query, new String[]{&#10;                    String.valueOf(budget.getUserId()),&#10;                    categoryName.trim(),&#10;                    String.valueOf(budget.getYear()),&#10;                    String.format(Locale.getDefault(), &quot;%02d&quot;, budget.getMonth())&#10;            });&#10;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#10;                double result = cursor.getDouble(0);&#10;                Log.d(TAG, &quot;Spent for category '&quot; + categoryName + &quot;': &quot; + result);&#10;                return result;&#10;            }&#10;        } catch (Exception e) {&#10;            Log.e(TAG, &quot;✗ Error calculating spent by category: &quot; + e.getMessage(), e);&#10;        } finally {&#10;            if (cursor != null) cursor.close();&#10;            if (db != null) db.close();&#10;        }&#10;&#10;        return 0;&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.campusexpensesmanagermer.Repositories;&#13;&#10;&#13;&#10;import android.content.ContentValues;&#13;&#10;import android.content.Context;&#13;&#10;import android.database.Cursor;&#13;&#10;import android.database.sqlite.SQLiteDatabase;&#13;&#10;import android.util.Log;&#13;&#10;&#13;&#10;import com.example.campusexpensesmanagermer.Data.SQLiteDbHelper;&#13;&#10;import com.example.campusexpensesmanagermer.Models.Budget;&#13;&#10;&#13;&#10;import java.text.SimpleDateFormat;&#13;&#10;import java.util.ArrayList;&#13;&#10;import java.util.Calendar;&#13;&#10;import java.util.Date;&#13;&#10;import java.util.List;&#13;&#10;import java.util.Locale;&#13;&#10;&#13;&#10;public class BudgetRepository {&#13;&#10;&#13;&#10;    private final SQLiteDbHelper dbHelper;&#13;&#10;    private static final String TAG = &quot;BudgetRepository&quot;;&#13;&#10;&#13;&#10;    public BudgetRepository(Context context) {&#13;&#10;        dbHelper = new SQLiteDbHelper(context);&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Thêm ngân sách mới&#13;&#10;     */&#13;&#10;    public long addBudget(Budget budget) {&#13;&#10;        if (budget == null) {&#13;&#10;            Log.e(TAG, &quot;Budget object is null&quot;);&#13;&#10;            return -1;&#13;&#10;        }&#13;&#10;&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getWritableDatabase();&#13;&#10;            ContentValues values = new ContentValues();&#13;&#10;&#13;&#10;            values.put(SQLiteDbHelper.USER_ID_BUDGET, budget.getUserId());&#13;&#10;            values.put(SQLiteDbHelper.YEAR_BUDGET, budget.getYear() &gt; 0 ? budget.getYear() : Calendar.getInstance().get(Calendar.YEAR));&#13;&#10;            values.put(SQLiteDbHelper.MONTH_BUDGET, budget.getMonth() &gt; 0 ? budget.getMonth() : Calendar.getInstance().get(Calendar.MONTH) + 1);&#13;&#10;            values.put(SQLiteDbHelper.TARGET_AMOUNT_BUDGET, budget.getMoney());&#13;&#10;            values.put(SQLiteDbHelper.CURRENCY_BUDGET, &quot;VND&quot;);&#13;&#10;            values.put(SQLiteDbHelper.NOTE_BUDGET, budget.getDescription());&#13;&#10;&#13;&#10;            long id = db.insert(SQLiteDbHelper.TABLE_BUDGETS, null, values);&#13;&#10;            Log.d(TAG, &quot;✓ Insert budget success - ID: &quot; + id + &quot;, UserId: &quot; + budget.getUserId()&#13;&#10;                    + &quot;, Month: &quot; + budget.getMonth() + &quot;, Year: &quot; + budget.getYear()&#13;&#10;                    + &quot;, Amount: &quot; + budget.getMoney());&#13;&#10;            return id;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error adding budget: &quot; + e.getMessage(), e);&#13;&#10;            return -1;&#13;&#10;        } finally {&#13;&#10;            if (db != null) {&#13;&#10;                db.close();&#13;&#10;            }&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Lấy ngân sách theo ID&#13;&#10;     */&#13;&#10;    public Budget getBudgetById(int budgetId) {&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        Cursor cursor = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getReadableDatabase();&#13;&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGETS +&#13;&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.ID_BUDGET + &quot; = ?&quot;;&#13;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(budgetId)});&#13;&#10;&#13;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#13;&#10;                Budget budget = new Budget();&#13;&#10;                budget.setId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ID_BUDGET)));&#13;&#10;                budget.setUserId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.USER_ID_BUDGET)));&#13;&#10;                budget.setYear(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.YEAR_BUDGET)));&#13;&#10;                budget.setMonth(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.MONTH_BUDGET)));&#13;&#10;                budget.setMoney(cursor.getDouble(cursor.getColumnIndexOrThrow(SQLiteDbHelper.TARGET_AMOUNT_BUDGET)));&#13;&#10;                budget.setDescription(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.NOTE_BUDGET)));&#13;&#10;&#13;&#10;                Log.d(TAG, &quot;✓ Found budget ID: &quot; + budgetId);&#13;&#10;                return budget;&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error getting budget: &quot; + e.getMessage(), e);&#13;&#10;        } finally {&#13;&#10;            if (cursor != null) cursor.close();&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;        return null;&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * ✅ FIX: Lấy ngân sách theo tháng/năm&#13;&#10;     * Trả về budget mới nhất nếu có nhiều budget cho cùng tháng/năm&#13;&#10;     */&#13;&#10;    public Budget getBudgetByUserAndMonth(int userId, int month, int year) {&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        Cursor cursor = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getReadableDatabase();&#13;&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGETS +&#13;&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.USER_ID_BUDGET + &quot; = ? &quot; +&#13;&#10;                    &quot;AND &quot; + SQLiteDbHelper.MONTH_BUDGET + &quot; = ? &quot; +&#13;&#10;                    &quot;AND &quot; + SQLiteDbHelper.YEAR_BUDGET + &quot; = ? &quot; +&#13;&#10;                    &quot;ORDER BY &quot; + SQLiteDbHelper.ID_BUDGET + &quot; DESC LIMIT 1&quot;;&#13;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(userId), String.valueOf(month), String.valueOf(year)});&#13;&#10;&#13;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#13;&#10;                Budget budget = new Budget();&#13;&#10;                budget.setId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ID_BUDGET)));&#13;&#10;                budget.setUserId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.USER_ID_BUDGET)));&#13;&#10;                budget.setYear(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.YEAR_BUDGET)));&#13;&#10;                budget.setMonth(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.MONTH_BUDGET)));&#13;&#10;                budget.setMoney(cursor.getDouble(cursor.getColumnIndexOrThrow(SQLiteDbHelper.TARGET_AMOUNT_BUDGET)));&#13;&#10;                budget.setDescription(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.NOTE_BUDGET)));&#13;&#10;&#13;&#10;                // ✅ FIX: Tính tổng chi tiêu chính xác&#13;&#10;                budget.setSpent(getTotalSpentByBudget(budget.getId()));&#13;&#10;&#13;&#10;                Log.d(TAG, &quot;✓ Found budget for &quot; + month + &quot;/&quot; + year + &quot; (userId=&quot; + userId&#13;&#10;                        + &quot;), Spent: &quot; + budget.getSpent());&#13;&#10;                return budget;&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error getting budget: &quot; + e.getMessage(), e);&#13;&#10;        } finally {&#13;&#10;            if (cursor != null) cursor.close();&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;        return null;&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Lấy tất cả ngân sách của user&#13;&#10;     */&#13;&#10;    public List&lt;Budget&gt; getAllBudgetsByUser(int userId) {&#13;&#10;        List&lt;Budget&gt; list = new ArrayList&lt;&gt;();&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        Cursor cursor = null;&#13;&#10;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getReadableDatabase();&#13;&#10;            String query = &quot;SELECT * FROM &quot; + SQLiteDbHelper.TABLE_BUDGETS +&#13;&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.USER_ID_BUDGET + &quot; = ? &quot; +&#13;&#10;                    &quot;ORDER BY &quot; + SQLiteDbHelper.YEAR_BUDGET + &quot; DESC, &quot; +&#13;&#10;                    SQLiteDbHelper.MONTH_BUDGET + &quot; DESC&quot;;&#13;&#10;            cursor = db.rawQuery(query, new String[]{String.valueOf(userId)});&#13;&#10;&#13;&#10;            if (cursor != null &amp;&amp; cursor.getCount() &gt; 0) {&#13;&#10;                while (cursor.moveToNext()) {&#13;&#10;                    Budget budget = new Budget();&#13;&#10;                    budget.setId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.ID_BUDGET)));&#13;&#10;                    budget.setUserId(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.USER_ID_BUDGET)));&#13;&#10;                    budget.setYear(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.YEAR_BUDGET)));&#13;&#10;                    budget.setMonth(cursor.getInt(cursor.getColumnIndexOrThrow(SQLiteDbHelper.MONTH_BUDGET)));&#13;&#10;                    budget.setMoney(cursor.getDouble(cursor.getColumnIndexOrThrow(SQLiteDbHelper.TARGET_AMOUNT_BUDGET)));&#13;&#10;                    budget.setDescription(cursor.getString(cursor.getColumnIndexOrThrow(SQLiteDbHelper.NOTE_BUDGET)));&#13;&#10;&#13;&#10;                    budget.setSpent(getTotalSpentByBudget(budget.getId()));&#13;&#10;                    list.add(budget);&#13;&#10;                }&#13;&#10;                Log.d(TAG, &quot;✓ Loaded &quot; + list.size() + &quot; budgets for userId: &quot; + userId);&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error getting budgets: &quot; + e.getMessage(), e);&#13;&#10;        } finally {&#13;&#10;            if (cursor != null) cursor.close();&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;&#13;&#10;        return list;&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Cập nhật ngân sách&#13;&#10;     */&#13;&#10;    public boolean updateBudget(Budget budget) {&#13;&#10;        if (budget == null || budget.getId() == 0) {&#13;&#10;            Log.e(TAG, &quot;Invalid budget object for update&quot;);&#13;&#10;            return false;&#13;&#10;        }&#13;&#10;&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getWritableDatabase();&#13;&#10;            ContentValues values = new ContentValues();&#13;&#10;            values.put(SQLiteDbHelper.MONTH_BUDGET, budget.getMonth());&#13;&#10;            values.put(SQLiteDbHelper.YEAR_BUDGET, budget.getYear());&#13;&#10;            values.put(SQLiteDbHelper.TARGET_AMOUNT_BUDGET, budget.getMoney());&#13;&#10;            values.put(SQLiteDbHelper.NOTE_BUDGET, budget.getDescription());&#13;&#10;            values.put(SQLiteDbHelper.UPDATED_AT, new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.getDefault()).format(new Date()));&#13;&#10;&#13;&#10;            int result = db.update(&#13;&#10;                    SQLiteDbHelper.TABLE_BUDGETS,&#13;&#10;                    values,&#13;&#10;                    SQLiteDbHelper.ID_BUDGET + &quot; = ?&quot;,&#13;&#10;                    new String[]{String.valueOf(budget.getId())}&#13;&#10;            );&#13;&#10;&#13;&#10;            boolean success = result &gt; 0;&#13;&#10;            Log.d(TAG, success ? &quot;✓ Update budget success&quot; : &quot;✗ Update budget failed&quot;);&#13;&#10;            return success;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error updating budget: &quot; + e.getMessage(), e);&#13;&#10;            return false;&#13;&#10;        } finally {&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Cập nhật ngân sách và chia đều số tiền cho các mục con của budget&#13;&#10;     */&#13;&#10;    public boolean updateBudgetAndSplit(int budgetId, double newAmount) {&#13;&#10;        if (budgetId &lt;= 0) {&#13;&#10;            Log.e(TAG, &quot;Invalid budgetId for updateBudgetAndSplit&quot;);&#13;&#10;            return false;&#13;&#10;        }&#13;&#10;&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        Cursor cursor = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getWritableDatabase();&#13;&#10;            db.beginTransaction();&#13;&#10;&#13;&#10;            // 1) Cập nhật bản ghi budgets&#13;&#10;            ContentValues values = new ContentValues();&#13;&#10;            values.put(SQLiteDbHelper.TARGET_AMOUNT_BUDGET, newAmount);&#13;&#10;            int updated = db.update(SQLiteDbHelper.TABLE_BUDGETS, values, SQLiteDbHelper.ID_BUDGET + &quot; = ?&quot;,&#13;&#10;                    new String[]{String.valueOf(budgetId)});&#13;&#10;&#13;&#10;            if (updated &lt;= 0) {&#13;&#10;                Log.e(TAG, &quot;✗ Update budget failed for id: &quot; + budgetId);&#13;&#10;                db.endTransaction();&#13;&#10;                return false;&#13;&#10;            }&#13;&#10;&#13;&#10;            // 2) Lấy danh sách budget items của budget này theo id (để phân phối phần dư một cách xác định)&#13;&#10;            String q = &quot;SELECT &quot; + SQLiteDbHelper.ID_BUDGET_ITEM + &quot; FROM &quot; + SQLiteDbHelper.TABLE_BUDGET_ITEMS +&#13;&#10;                    &quot; WHERE &quot; + SQLiteDbHelper.BUDGET_ID_ITEM + &quot; = ? ORDER BY &quot; + SQLiteDbHelper.ID_BUDGET_ITEM + &quot; ASC&quot;;&#13;&#10;            cursor = db.rawQuery(q, new String[]{String.valueOf(budgetId)});&#13;&#10;&#13;&#10;            List&lt;Integer&gt; itemIds = new java.util.ArrayList&lt;&gt;();&#13;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#13;&#10;                do {&#13;&#10;                    itemIds.add(cursor.getInt(0));&#13;&#10;                } while (cursor.moveToNext());&#13;&#10;            }&#13;&#10;&#13;&#10;            int n = itemIds.size();&#13;&#10;            if (n &gt; 0) {&#13;&#10;                // Dùng đơn vị cents để tránh lỗi làm tròn&#13;&#10;                long totalCents = Math.round(newAmount * 100.0);&#13;&#10;                long base = totalCents / n;&#13;&#10;                int rem = (int) (totalCents % n);&#13;&#10;&#13;&#10;                for (int i = 0; i &lt; n; i++) {&#13;&#10;                    long amountCents = base + (i &lt; rem ? 1 : 0);&#13;&#10;                    double allocated = amountCents / 100.0;&#13;&#10;&#13;&#10;                    ContentValues v2 = new ContentValues();&#13;&#10;                    v2.put(SQLiteDbHelper.ALLOCATED_AMOUNT_ITEM, allocated);&#13;&#10;&#13;&#10;                    int r = db.update(SQLiteDbHelper.TABLE_BUDGET_ITEMS, v2,&#13;&#10;                            SQLiteDbHelper.ID_BUDGET_ITEM + &quot; = ?&quot;, new String[]{String.valueOf(itemIds.get(i))});&#13;&#10;&#13;&#10;                    if (r &lt;= 0) {&#13;&#10;                        Log.e(TAG, &quot;✗ Failed to update budget item id: &quot; + itemIds.get(i));&#13;&#10;                        // continue trying to update others but mark failure&#13;&#10;                    } else {&#13;&#10;                        Log.d(TAG, &quot;✓ Updated budget item id=&quot; + itemIds.get(i) + &quot; allocated=&quot; + allocated);&#13;&#10;                    }&#13;&#10;                }&#13;&#10;            } else {&#13;&#10;                Log.d(TAG, &quot;No budget items found for budgetId=&quot; + budgetId + &quot;, nothing to split.&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            db.setTransactionSuccessful();&#13;&#10;            return true;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error in updateBudgetAndSplit: &quot; + e.getMessage(), e);&#13;&#10;            return false;&#13;&#10;        } finally {&#13;&#10;            if (cursor != null) cursor.close();&#13;&#10;            if (db != null) {&#13;&#10;                try {&#13;&#10;                    db.endTransaction();&#13;&#10;                } catch (Exception ignored) {}&#13;&#10;                db.close();&#13;&#10;            }&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * Xóa ngân sách&#13;&#10;     */&#13;&#10;    public boolean deleteBudget(int budgetId) {&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getWritableDatabase();&#13;&#10;&#13;&#10;            // Xóa budget items trước&#13;&#10;            db.delete(SQLiteDbHelper.TABLE_BUDGET_ITEMS,&#13;&#10;                    SQLiteDbHelper.BUDGET_ID_ITEM + &quot; = ?&quot;,&#13;&#10;                    new String[]{String.valueOf(budgetId)});&#13;&#10;&#13;&#10;            // Xóa budget&#13;&#10;            int result = db.delete(&#13;&#10;                    SQLiteDbHelper.TABLE_BUDGETS,&#13;&#10;                    SQLiteDbHelper.ID_BUDGET + &quot; = ?&quot;,&#13;&#10;                    new String[]{String.valueOf(budgetId)}&#13;&#10;            );&#13;&#10;&#13;&#10;            boolean success = result &gt; 0;&#13;&#10;            Log.d(TAG, success ? &quot;✓ Delete budget success&quot; : &quot;✗ Delete budget failed&quot;);&#13;&#10;            return success;&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error deleting budget: &quot; + e.getMessage(), e);&#13;&#10;            return false;&#13;&#10;        } finally {&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * ✅ FIX: Tính tổng chi tiêu theo budget (sum của tất cả chi tiêu trong tháng/năm)&#13;&#10;     * Sử dụng TRIM() để so sánh chính xác category&#13;&#10;     */&#13;&#10;    public double getTotalSpentByBudget(int budgetId) {&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        Cursor cursor = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getReadableDatabase();&#13;&#10;&#13;&#10;            Budget budget = getBudgetById(budgetId);&#13;&#10;            if (budget == null) {&#13;&#10;                return 0;&#13;&#10;            }&#13;&#10;&#13;&#10;            // ✅ FIX: Tính tổng chi tiêu từ express trong tháng/năm&#13;&#10;            String query = &quot;SELECT COALESCE(SUM(e.&quot; + SQLiteDbHelper.AMOUNT_EXPRESS + &quot;), 0) as total &quot; +&#13;&#10;                    &quot;FROM &quot; + SQLiteDbHelper.TABLE_EXPRESS + &quot; e &quot; +&#13;&#10;                    &quot;WHERE e.&quot; + SQLiteDbHelper.USER_ID_EXPRESS + &quot; = ? &quot; +&#13;&#10;                    &quot;AND strftime('%Y', e.&quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ? &quot; +&#13;&#10;                    &quot;AND strftime('%m', e.&quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ?&quot;;&#13;&#10;&#13;&#10;            cursor = db.rawQuery(query, new String[]{&#13;&#10;                    String.valueOf(budget.getUserId()),&#13;&#10;                    String.valueOf(budget.getYear()),&#13;&#10;                    String.format(Locale.getDefault(), &quot;%02d&quot;, budget.getMonth())&#13;&#10;            });&#13;&#10;&#13;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#13;&#10;                double total = cursor.getDouble(0);&#13;&#10;                Log.d(TAG, &quot;Total spent for budget &quot; + budgetId + &quot; (&quot; + budget.getMonth()&#13;&#10;                        + &quot;/&quot; + budget.getYear() + &quot;): &quot; + total);&#13;&#10;                return total;&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error calculating total spent: &quot; + e.getMessage(), e);&#13;&#10;        } finally {&#13;&#10;            if (cursor != null) cursor.close();&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;&#13;&#10;        return 0;&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * ✅ FIX: Tính chi tiêu theo category&#13;&#10;     * Sử dụng TRIM() để so sánh chính xác&#13;&#10;     */&#13;&#10;    public double getSpentByCategory(int budgetId, String categoryName) {&#13;&#10;        SQLiteDatabase db = null;&#13;&#10;        Cursor cursor = null;&#13;&#10;        try {&#13;&#10;            db = dbHelper.getReadableDatabase();&#13;&#10;            Budget budget = getBudgetById(budgetId);&#13;&#10;            if (budget == null) return 0;&#13;&#10;&#13;&#10;            String query = &quot;SELECT COALESCE(SUM(e.&quot; + SQLiteDbHelper.AMOUNT_EXPRESS + &quot;), 0) as total &quot; +&#13;&#10;                    &quot;FROM &quot; + SQLiteDbHelper.TABLE_EXPRESS + &quot; e &quot; +&#13;&#10;                    &quot;WHERE e.&quot; + SQLiteDbHelper.USER_ID_EXPRESS + &quot; = ? &quot; +&#13;&#10;                    &quot;AND TRIM(e.&quot; + SQLiteDbHelper.CATEGORY_ID_EXPRESS + &quot;) = TRIM(?) &quot; +&#13;&#10;                    &quot;AND strftime('%Y', e.&quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ? &quot; +&#13;&#10;                    &quot;AND strftime('%m', e.&quot; + SQLiteDbHelper.DATE_EXPRESS + &quot;) = ?&quot;;&#13;&#10;&#13;&#10;            cursor = db.rawQuery(query, new String[]{&#13;&#10;                    String.valueOf(budget.getUserId()),&#13;&#10;                    categoryName.trim(),&#13;&#10;                    String.valueOf(budget.getYear()),&#13;&#10;                    String.format(Locale.getDefault(), &quot;%02d&quot;, budget.getMonth())&#13;&#10;            });&#13;&#10;&#13;&#10;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {&#13;&#10;                double result = cursor.getDouble(0);&#13;&#10;                Log.d(TAG, &quot;Spent for category '&quot; + categoryName + &quot;': &quot; + result);&#13;&#10;                return result;&#13;&#10;            }&#13;&#10;        } catch (Exception e) {&#13;&#10;            Log.e(TAG, &quot;✗ Error calculating spent by category: &quot; + e.getMessage(), e);&#13;&#10;        } finally {&#13;&#10;            if (cursor != null) cursor.close();&#13;&#10;            if (db != null) db.close();&#13;&#10;        }&#13;&#10;&#13;&#10;        return 0;&#13;&#10;    }&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>