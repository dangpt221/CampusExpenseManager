<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/BUG_REPORT.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/BUG_REPORT.md" />
              <option name="updatedContent" value="#  BUG REPORT: Lỗi &quot;Ghi lại thất bại&quot; (Recording Failed)&#10;&#10;##  Tóm Tắt&#10;Lỗi &quot;Lỗi: Ghi lại thất bại&quot; xảy ra khi người dùng thêm ngân sách mới. Nguyên nhân là các budget item không được ghi vào database đúng cách.&#10;&#10;---&#10;&#10;##  NGUYÊN NHÂN TÌM ĐƯỢC&#10;&#10;### **1. ❌ BudgetItemRepository.java - Thiếu Validation**&#10;**File:** `app/src/main/java/com/example/campusexpensesmanagermer/Repositories/BudgetItemRepository.java`&#10;&#10;**Vấn đề:**&#10;- Hàm `addBudgetItem()` không kiểm tra tính hợp lệ của dữ liệu đầu vào&#10;- Nếu `budgetId = 0`, `categoryName = null`, hoặc `allocatedAmount &lt; 0` → dữ liệu lỗi sẽ được insert&#10;- Khi database reject insert, không log chi tiết lỗi → dễ bỏ sót&#10;&#10;**Dòng lỗi (~44):**&#10;```java&#10;long id = db.insert(SQLiteDbHelper.TABLE_BUDGET_ITEMS, null, values);&#10;Log.d(TAG, &quot;✓ Insert budget item success - ID: &quot; + id + &quot;, Category: &quot; + item.getCategoryName());&#10;```&#10;&#10;**Vấn đề:** Log luôn in &quot;success&quot; mặc dù insert có thể thất bại (trả về -1)&#10;&#10;**Giải pháp đã áp dụng:**&#10;✅ Thêm validation cho:&#10;- `budgetId &gt; 0`&#10;- `categoryName != null &amp;&amp; !empty`&#10;- `allocatedAmount &gt;= 0`&#10;✅ Kiểm tra nếu `db.insert()` trả về -1 → log lỗi chi tiết&#10;&#10;---&#10;&#10;### **2. ❌ AddBudgetActivity.java - Không Kiểm Tra Kết Quả Ghi**&#10;**File:** `app/src/main/java/com/example/campusexpensesmanagermer/Activities/Budgets/AddBudgetActivity.java`&#10;&#10;**Vấn đề:**&#10;```java&#10;for (String category : categories) {&#10;    BudgetItem item = new BudgetItem();&#10;    item.setBudgetId((int) budgetId);&#10;    item.setCategoryName(category);&#10;    item.setAllocatedAmount(amountPerCategory);&#10;    budgetItemRepository.addBudgetItem(item);  // ❌ KHÔNG kiểm tra kết quả return&#10;}&#10;```&#10;&#10;- Hàm gọi `addBudgetItem()` nhưng **bỏ qua kết quả trả về**&#10;- Nếu insert thất bại, code vẫn in &quot;✅ Thêm ngân sách thành công!&quot; (SAI!)&#10;- Người dùng không biết một số danh mục đã thất bại&#10;&#10;**Giải pháp đã áp dụng:**&#10;✅ Kiểm tra `long itemId = budgetItemRepository.addBudgetItem(item)`&#10;✅ Đếm số danh mục thành công vs thất bại&#10;✅ Thông báo kết quả đúng cho người dùng&#10;✅ Log chi tiết tất cả lỗi&#10;&#10;---&#10;&#10;### **3. ⚠️ SQLiteDbHelper.java - Schema OK nhưng cần kiểm tra**&#10;**File:** `app/src/main/java/com/example/campusexpensesmanagermer/Data/SQLiteDbHelper.java`&#10;&#10;**Kiểm tra Schema:**&#10;```sql&#10;CREATE TABLE IF NOT EXISTS budget_items (&#10;    id INTEGER PRIMARY KEY AUTOINCREMENT,&#10;    budget_id INTEGER NOT NULL,&#10;    category_id TEXT,&#10;    allocated_amount REAL NOT NULL,&#10;    created_at DATETIME DEFAULT (datetime('now')),&#10;    FOREIGN KEY(budget_id) REFERENCES budgets(id) ON DELETE CASCADE&#10;)&#10;```&#10;&#10;**Vấn đề tiềm ẩn:**&#10;- `category_id` có kiểu TEXT nhưng tên cột gây nhầm lẫn (nên là category_name)&#10;- `allocated_amount` là NOT NULL → phải kiểm tra trước insert&#10;&#10;**Kết luận:** Schema OK, nhưng cần validation tốt hơn ở layer Repository&#10;&#10;---&#10;&#10;## ️ GIẢI PHÁP ĐÃ THỰC HIỆN&#10;&#10;### **File 1: BudgetItemRepository.java**&#10;✅ **Thêm validation:**&#10;```java&#10;if (item.getBudgetId() &lt;= 0) {&#10;    Log.e(TAG, &quot;Budget ID is invalid: &quot; + item.getBudgetId());&#10;    return -1;&#10;}&#10;if (item.getCategoryName() == null || item.getCategoryName().trim().isEmpty()) {&#10;    Log.e(TAG, &quot;Category name is null or empty&quot;);&#10;    return -1;&#10;}&#10;if (item.getAllocatedAmount() &lt; 0) {&#10;    Log.e(TAG, &quot;Allocated amount is negative: &quot; + item.getAllocatedAmount());&#10;    return -1;&#10;}&#10;```&#10;&#10;✅ **Kiểm tra kết quả insert:**&#10;```java&#10;long id = db.insert(SQLiteDbHelper.TABLE_BUDGET_ITEMS, null, values);&#10;if (id == -1) {&#10;    Log.e(TAG, &quot;✗ Insert failed - returned -1. Item: &quot; + item.toString());&#10;    return -1;&#10;}&#10;```&#10;&#10;✅ **Log chi tiết khi lỗi:**&#10;```java&#10;Log.e(TAG, &quot;Item details - BudgetId: &quot; + item.getBudgetId() + &#10;            &quot;, Category: &quot; + item.getCategoryName() + &#10;            &quot;, Amount: &quot; + item.getAllocatedAmount());&#10;```&#10;&#10;### **File 2: AddBudgetActivity.java**&#10;✅ **Kiểm tra kết quả từng item:**&#10;```java&#10;int successCount = 0;&#10;int failCount = 0;&#10;&#10;for (String category : categories) {&#10;    // ... tạo item ...&#10;    long itemId = budgetItemRepository.addBudgetItem(item);&#10;    if (itemId &gt; 0) {&#10;        successCount++;&#10;        Log.d(TAG, &quot;✓ Budget item created: &quot; + category);&#10;    } else {&#10;        failCount++;&#10;        Log.e(TAG, &quot;✗ Failed to create budget item: &quot; + category);&#10;    }&#10;}&#10;```&#10;&#10;✅ **Thông báo chính xác:**&#10;```java&#10;if (failCount == 0) {&#10;    Toast.makeText(this, &quot;✅ Thêm ngân sách thành công! (&quot; + successCount + &quot; danh mục)&quot;, &#10;                   Toast.LENGTH_SHORT).show();&#10;} else {&#10;    Toast.makeText(this, &quot;⚠️ Thêm ngân sách thành công nhưng &quot; + failCount + &quot;/&quot; + &#10;                   categories.length + &quot; danh mục thất bại.\nXem Logcat để chi tiết.&quot;, &#10;                   Toast.LENGTH_LONG).show();&#10;}&#10;```&#10;&#10;---&#10;&#10;##  CÁC BƯỚC KIỂM TRA&#10;&#10;1. **Chạy ứng dụng &amp; mở Logcat**&#10;   - Filter: `BudgetItemRepository` hoặc `AddBudgetActivity`&#10;&#10;2. **Thêm ngân sách mới:**&#10;   - Nhập số tiền: **12000**&#10;   - Chọn tháng/năm&#10;   - Nhấn &quot;Ghi lại&quot;&#10;&#10;3. **Kiểm tra kết quả:**&#10;   - ✅ Nếu thành công: Sẽ in 9 dòng log &quot;✓ Budget item created&quot;&#10;   - ❌ Nếu lỗi: Sẽ in chi tiết lỗi: `Budget ID is invalid`, `Category name is null`, v.v.&#10;&#10;4. **Kiểm tra Database:**&#10;   ```sql&#10;   SELECT * FROM budget_items WHERE budget_id = [ID_VỪA_TẠO];&#10;   ```&#10;   Nên có 9 records (một cho mỗi danh mục)&#10;&#10;---&#10;&#10;##  BƯỚC TIẾP THEO&#10;&#10;1. **Rebuild &amp; test lại:**&#10;   ```bash&#10;   ./gradlew clean build&#10;   ```&#10;&#10;2. **Nếu vẫn lỗi, kiểm tra:**&#10;   - Xem Logcat để lấy **exact error message**&#10;   - Verify Database schema (chạy `adb shell sqlite3` để check)&#10;   - Kiểm tra Foreign Key constraint (có thể budgetId không tồn tại)&#10;&#10;3. **Cách debug chi tiết hơn:**&#10;   - Thêm try-catch ở `AddBudgetActivity.addBudget()` ngoài vòng lặp&#10;   - Log toàn bộ exception stack trace&#10;&#10;---&#10;&#10;##  TÓNG KẾT&#10;&#10;| Vấn đề | Nguyên nhân | Giải pháp |&#10;|-------|-----------|----------|&#10;| Thiếu validation input | `BudgetItemRepository` không kiểm tra | ✅ Thêm validation cho budgetId, categoryName, amount |&#10;| Không detect insert failure | Log luôn &quot;success&quot; | ✅ Kiểm tra `db.insert()` trả về -1 |&#10;| Không notify người dùng | `AddBudgetActivity` bỏ qua kết quả | ✅ Kiểm tra return value &amp; đếm success/fail |&#10;| Thiếu log chi tiết | Khó debug | ✅ Log toàn bộ item details khi error |&#10;&#10;---&#10;&#10;**Status:** ✅ **FIXED** - Các file đã được cập nhật&#10;**Test:** ⏳ Pending - Cần rebuild &amp; chạy để xác nhận&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/DEBUG_GUIDE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/DEBUG_GUIDE.md" />
              <option name="updatedContent" value="#  HƯỚNG DẪN DEBUG: Lỗi Ghi Lại Thất Bại&#10;&#10;##  Cách Kiểm Tra Logcat&#10;&#10;### **Bước 1: Mở Logcat trong Android Studio**&#10;```&#10;View → Tool Windows → Logcat&#10;hoặc: Alt + 6&#10;```&#10;&#10;### **Bước 2: Filter log theo tag**&#10;```&#10;BudgetItemRepository&#10;AddBudgetActivity&#10;SQLite&#10;Exception&#10;```&#10;&#10;### **Bước 3: Chạy app &amp; tạo ngân sách mới**&#10;1. Nhấn nút &quot;Ghi lại&quot; (Add Budget)&#10;2. Nhập số tiền: **12000**&#10;3. Nhấn &quot;Ghi lại&quot;&#10;4. Xem Logcat&#10;&#10;---&#10;&#10;## ✅ KỲ VỌNG LOG KHI THÀNH CÔNG&#10;&#10;```&#10;D/BudgetRepository: ✓ Insert budget success - ID: 1, UserId: 1&#10;D/AddBudgetActivity: Creating 9 budget items with amount: 1333.3333333333333 each&#10;D/BudgetItemRepository: ✓ Insert budget item success - ID: 1, Category: Ăn uống, Amount: 1333.3333333333333&#10;D/BudgetItemRepository: ✓ Insert budget item success - ID: 2, Category: Giao thông, Amount: 1333.3333333333333&#10;D/BudgetItemRepository: ✓ Insert budget item success - ID: 3, Category: Mua sắm, Amount: 1333.3333333333333&#10;D/BudgetItemRepository: ✓ Insert budget item success - ID: 4, Category: Giải trí, Amount: 1333.3333333333333&#10;D/BudgetItemRepository: ✓ Insert budget item success - ID: 5, Category: Y tế, Amount: 1333.3333333333333&#10;D/BudgetItemRepository: ✓ Insert budget item success - ID: 6, Category: Giáo dục, Amount: 1333.3333333333333&#10;D/BudgetItemRepository: ✓ Insert budget item success - ID: 7, Category: Nhà ở, Amount: 1333.3333333333333&#10;D/BudgetItemRepository: ✓ Insert budget item success - ID: 8, Category: Utilities, Amount: 1333.3333333333333&#10;D/BudgetItemRepository: ✓ Insert budget item success - ID: 9, Category: Khác, Amount: 1333.3333333333333&#10;```&#10;&#10;---&#10;&#10;## ❌ KỲ VỌNG LOG KHI CÓ LỖI&#10;&#10;### **Lỗi 1: Budget ID không hợp lệ**&#10;```&#10;E/BudgetItemRepository: Budget ID is invalid: 0&#10;E/BudgetItemRepository: ✗ Failed to create budget item: Ăn uống&#10;```&#10;&#10;### **Lỗi 2: Category name là null**&#10;```&#10;E/BudgetItemRepository: Category name is null or empty&#10;E/BudgetItemRepository: ✗ Failed to create budget item: Ăn uống&#10;```&#10;&#10;### **Lỗi 3: Database error (Foreign Key constraint)**&#10;```&#10;E/BudgetItemRepository: ✗ Error adding budget item: UNIQUE constraint failed&#10;E/BudgetItemRepository: Item details - BudgetId: 1, Category: Ăn uống, Amount: 1333.33&#10;```&#10;&#10;### **Lỗi 4: Database không tồn tại (rare)**&#10;```&#10;E/BudgetItemRepository: ✗ Error adding budget item: no such table: budget_items&#10;```&#10;&#10;---&#10;&#10;## ️ Cách Kiểm Tra Database Trực Tiếp&#10;&#10;### **Bước 1: Kết nối Database via ADB**&#10;```bash&#10;# Lấy ID app&#10;adb shell pm list packages | grep campus&#10;&#10;# Kết nối database&#10;adb shell&#10;run-as com.example.campusexpensesmanagermer&#10;cd /data/data/com.example.campusexpensesmanagermer/databases&#10;sqlite3 campus_expense.db&#10;&#10;# Hoặc nhanh hơn&#10;adb shell &quot;run-as com.example.campusexpensesmanagermer sqlite3 /data/data/com.example.campusexpensesmanagermer/databases/campus_expense.db&quot;&#10;```&#10;&#10;### **Bước 2: Kiểm tra dữ liệu**&#10;```sql&#10;-- Kiểm tra budgets&#10;SELECT * FROM budgets;&#10;&#10;-- Kiểm tra budget_items&#10;SELECT * FROM budget_items;&#10;&#10;-- Chi tiết budget_items&#10;SELECT b.id, b.category_id, b.allocated_amount, b.budget_id &#10;FROM budget_items b &#10;ORDER BY b.id DESC LIMIT 20;&#10;&#10;-- Đếm số items&#10;SELECT COUNT(*) FROM budget_items;&#10;&#10;-- Kiểm tra constraints&#10;PRAGMA foreign_key_list(budget_items);&#10;&#10;-- Thoát&#10;.quit&#10;```&#10;&#10;---&#10;&#10;##  Các Lỗi Thường Gặp &amp; Cách Fix&#10;&#10;### **Lỗi 1: &quot;FOREIGN KEY constraint failed&quot;**&#10;**Nguyên nhân:** `budget_id` trong insert không tồn tại ở bảng `budgets`&#10;**Fix:**&#10;```java&#10;// Trong BudgetRepository.addBudget()&#10;// Verify budgetId được trả về &gt; 0&#10;if (id == -1) {&#10;    Log.e(TAG, &quot;Failed to insert budget!&quot;);&#10;    return -1;&#10;}&#10;```&#10;&#10;### **Lỗi 2: &quot;UNIQUE constraint failed&quot;**&#10;**Nguyên nhân:** Đang insert record trùng lặp&#10;**Fix:** Xóa dữ liệu cũ hoặc thêm check trùng&#10;&#10;### **Lỗi 3: &quot;no such column&quot;**&#10;**Nguyên nhân:** Tên cột sai hoặc database schema cũ&#10;**Fix:** Increment DB_VERSION để trigger `onUpgrade()`&#10;&#10;### **Lỗi 4: &quot;database is locked&quot;**&#10;**Nguyên nhân:** Không đóng `db` sau khi xong&#10;**Fix:** Luôn dùng `finally { if (db != null) db.close(); }`&#10;&#10;---&#10;&#10;##  Chi Tiết Schema Kiểm Tra&#10;&#10;```sql&#10;-- Kiểm tra structure bảng&#10;.schema budget_items&#10;&#10;-- Output mong đợi:&#10;CREATE TABLE IF NOT EXISTS budget_items (&#10;    id INTEGER PRIMARY KEY AUTOINCREMENT, &#10;    budget_id INTEGER NOT NULL, &#10;    category_id TEXT, &#10;    allocated_amount REAL NOT NULL, &#10;    created_at DATETIME DEFAULT (datetime('now')), &#10;    FOREIGN KEY(budget_id) REFERENCES budgets(id) ON DELETE CASCADE&#10;);&#10;&#10;-- Kiểm tra indexes&#10;.indexes budget_items&#10;```&#10;&#10;---&#10;&#10;##  Automated Debug Script&#10;&#10;**Tạo file: `debug_database.sh`**&#10;```bash&#10;#!/bin/bash&#10;APP_PACKAGE=&quot;com.example.campusexpensesmanagermer&quot;&#10;DB_PATH=&quot;/data/data/${APP_PACKAGE}/databases/campus_expense.db&quot;&#10;&#10;echo &quot;=== Checking Database ===&quot;&#10;adb shell &quot;run-as ${APP_PACKAGE} sqlite3 ${DB_PATH} '.schema budget_items'&quot;&#10;&#10;echo -e &quot;\n=== Budgets Records ===&quot;&#10;adb shell &quot;run-as ${APP_PACKAGE} sqlite3 ${DB_PATH} 'SELECT COUNT(*) as total_budgets FROM budgets;'&quot;&#10;&#10;echo -e &quot;\n=== Budget Items Records ===&quot;&#10;adb shell &quot;run-as ${APP_PACKAGE} sqlite3 ${DB_PATH} 'SELECT COUNT(*) as total_items FROM budget_items;'&quot;&#10;&#10;echo -e &quot;\n=== Recent Budget Items ===&quot;&#10;adb shell &quot;run-as ${APP_PACKAGE} sqlite3 ${DB_PATH} 'SELECT * FROM budget_items ORDER BY id DESC LIMIT 10;'&quot;&#10;&#10;echo -e &quot;\n=== Foreign Key Check ===&quot;&#10;adb shell &quot;run-as ${APP_PACKAGE} sqlite3 ${DB_PATH} 'PRAGMA foreign_key_list(budget_items);'&quot;&#10;```&#10;&#10;**Chạy script:**&#10;```bash&#10;chmod +x debug_database.sh&#10;./debug_database.sh&#10;```&#10;&#10;---&#10;&#10;##  Checklist Debug&#10;&#10;- [ ] Logcat có log &quot;✓ Insert budget item success&quot; cho 9 items?&#10;- [ ] Toast thông báo &quot;✅ Thêm ngân sách thành công! (9 danh mục)&quot;?&#10;- [ ] Database có 9 records mới trong `budget_items`?&#10;- [ ] Foreign key constraint không bị vi phạm?&#10;- [ ] `allocated_amount` có giá trị hợp lệ (&gt;0)?&#10;- [ ] `category_id` không phải null?&#10;&#10;---&#10;&#10;## ✅ Khi Nào Fix Thành Công&#10;&#10;1. ✅ App không crash khi thêm budget&#10;2. ✅ Toast hiển thị &quot;✅ Thêm ngân sách thành công!&quot;&#10;3. ✅ Logcat không có error&#10;4. ✅ Database có 9 items mới&#10;5. ✅ Quay lại màn hình chính, nhấn vào budget → thấy 9 danh mục với số tiền đã phân bổ&#10;&#10;---&#10;&#10;**Happy Debugging! **&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>